<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Portal | MedData</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="/static/js/chart.min.js?v=3"></script>
    <script src="/static/js/confetti.min.js"></script>
    <style>
        :root {
            --bg-dark: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.4);
            --glass-border: rgba(255, 255, 255, 0.08);
            --primary: #38bdf8;
            --accent: #818cf8;
            --success: #34d399;
            --danger: #f87171;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            color-scheme: dark; /* Force browser UI to dark mode */
        }

        body {
            margin: 0; font-family: 'Outfit', sans-serif; 
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: var(--text-main);
            min-height: 100vh; display: flex; flex-direction: column;
            overflow-x: hidden;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #0f172a; } /* Explicit Hex */
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 5px; border: 2px solid #0f172a; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Ambient Background */
        .ambient-glow {
            position: fixed; top: -20vh; left: -10vw; width: 50vw; height: 50vw;
            background: radial-gradient(circle, rgba(56, 189, 248, 0.15), transparent 70%);
            filter: blur(80px); z-index: -1; animation: float 10s ease-in-out infinite alternate;
        }
        @keyframes float { 0% { transform: translate(0,0); } 100% { transform: translate(20px, 30px); } }

        /* --- HEADER --- */
        .header {
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(16px);
            padding: 15px 30px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--glass-border); position: sticky; top: 0; z-index: 50;
        }
        .brand { font-weight: 700; font-size: 1.4rem; background: linear-gradient(to right, var(--primary), var(--accent)); -webkit-background-clip: text; color: transparent; letter-spacing: -0.5px; }
        
        .wallet-pill { 
            background: rgba(52, 211, 153, 0.1); color: var(--success); 
            padding: 8px 20px; border-radius: 30px; font-weight: 600; font-size: 0.95rem;
            display: flex; align-items: center; gap: 8px; border: 1px solid rgba(52, 211, 153, 0.2);
            transition: 0.3s; cursor: pointer;
        }
        .wallet-pill:hover { background: rgba(52, 211, 153, 0.2); box-shadow: 0 0 15px rgba(52, 211, 153, 0.2); }
        
        /* Gamification Styles */
        .milestone { text-align:center; position:relative; z-index:1; opacity:0.5; transition:0.3s; }
        .milestone.active { opacity:1; }
        .milestone .dot { width:24px; height:24px; background:#1e1e1e; border:2px solid var(--text-muted); border-radius:50%; margin:0 auto 10px; position:relative; transition:0.3s; }
        .milestone.active .dot { background:#facc15; border-color:#facc15; box-shadow:0 0 15px rgba(250, 204, 21, 0.4); }
        .milestone .label { font-size:0.8rem; font-weight:500; }

        /* --- CONTAINER --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; width: 100%; flex: 1; display: flex; flex-direction: column; }

        /* --- TABS --- */
        .tabs { 
            display: flex; gap: 8px; background: rgba(15, 23, 42, 0.5); padding: 6px; 
            border-radius: 14px; border: 1px solid var(--glass-border); width: fit-content; margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        .tab-btn {
            background: transparent; border: none; color: var(--text-muted);
            padding: 10px 24px; border-radius: 10px; font-weight: 500; cursor: pointer; transition: 0.3s;
            font-size: 0.95rem;
        }
        .tab-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .tab-btn.active { background: rgba(56, 189, 248, 0.15); color: var(--primary); border: 1px solid rgba(56, 189, 248, 0.2); }

        /* --- HERO SECTION (Empty State) --- */
        .hero-empty {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 60px 20px; opacity: 0; animation: fadeIn 0.8s forwards;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .hero-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.8; filter: drop-shadow(0 0 20px rgba(56, 189, 248, 0.3)); }
        .hero-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 15px; background: linear-gradient(to bottom, #fff, #94a3b8); -webkit-background-clip: text; color: transparent; }
        .hero-sub { font-size: 1.1rem; color: var(--text-muted); max-width: 500px; line-height: 1.6; margin-bottom: 40px; }
        
        .hero-stats { display: flex; gap: 30px; margin-bottom: 40px; }
        .stat-item { text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: 700; color: white; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        /* --- GRID & CARDS --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }

        .card {
            background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px;
            padding: 30px; transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); position: relative; overflow: hidden;
            backdrop-filter: blur(12px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .card::before { content:''; position: absolute; top:0; left:0; width:100%; height:4px; background: linear-gradient(90deg, var(--primary), var(--accent)); opacity: 0.8; }

        .card-top { display: flex; justify-content: space-between; margin-bottom: 25px; align-items: flex-start; }
        .batch-title { font-size: 1.25rem; font-weight: 700; color: white; margin-bottom: 6px; }
        .batch-sub { font-size: 0.85rem; color: var(--text-muted); }
        
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-active { background: rgba(59, 130, 246, 0.1); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.2); }
        .status-warn { background: rgba(234, 179, 8, 0.1); color: #facc15; border: 1px solid rgba(234, 179, 8, 0.2); }
        .status-success { background: rgba(34, 197, 94, 0.1); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.2); }
        .status-error { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }    .progress-track { height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; margin: 25px 0 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 10px; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px rgba(56, 189, 248, 0.3); }
        .progress-text { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-muted); font-weight: 600; }

        /* --- BUTTONS --- */
        .btn { width: 100%; padding: 14px; border-radius: 12px; font-weight: 600; cursor: pointer; border: none; transition: 0.3s; margin-top: 25px; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: white; color: #0f172a; }
        .btn-primary:hover { background: #f1f5f9; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,255,255,0.2); }
        .btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; }
        .btn-outline:hover { border-color: white; background: rgba(255,255,255,0.05); }
        .btn-disabled { background: rgba(255,255,255,0.05); color: var(--text-muted); cursor: not-allowed; }

        /* --- PROFILE --- */
        .profile-container {
            display: grid; grid-template-columns: 320px 1fr; gap: 40px;
            animation: fadeIn 0.5s ease-out;
        }
        .profile-card {
            background: var(--glass-bg); padding: 40px; border-radius: 24px; border: 1px solid var(--glass-border);
            text-align: center; height: fit-content; backdrop-filter: blur(12px);
        }
        .avatar-glow {
            width: 140px; height: 140px; border-radius: 50%; object-fit: cover;
            border: 4px solid var(--primary); margin-bottom: 25px;
            box-shadow: 0 0 30px rgba(56, 189, 248, 0.2);
        }
        
        .form-section { background: var(--glass-bg); padding: 40px; border-radius: 24px; border: 1px solid var(--glass-border); }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        
        .input-wrap label { display: block; color: var(--text-muted); font-size: 0.75rem; font-weight: 600; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .input-wrap input { 
            width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); 
            padding: 14px 16px; border-radius: 12px; color: white; transition: 0.3s;
        }
        .input-wrap input:focus { border-color: var(--primary); outline: none; background: rgba(0,0,0,0.3); }
        .input-wrap input:disabled { border-color: transparent; background: transparent; padding-left: 0; opacity: 0.8; }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal { background: #1e293b; padding: 40px; border-radius: 24px; width: 500px; border: 1px solid var(--glass-border); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); position: relative; }
        
        /* --- TOAST --- */
        #toast {
            position: fixed; bottom: 40px; right: 40px;
            background: white; color: #0f172a; padding: 16px 30px; border-radius: 16px; 
            font-weight: 600; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 200;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: translateY(200%); display: flex; align-items: center; gap: 12px;
        }
        #toast.show { transform: translateY(0); }


        
        /* --- CHAT WIDGET (Facebook Style) --- */
        #chatWidget {
            position: fixed; bottom: 0; right: 20px;
            width: 320px; height: 400px;
            background: #1e293b; border-radius: 8px 8px 0 0;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: none; flex-direction: column; overflow: hidden;
            z-index: 2000; border: 1px solid var(--border); border-bottom: none;
            animation: slideInUp 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .chat-header {
            background: var(--primary); color: #0f172a; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 700; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chat-header .status-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; display: inline-block; margin-right: 6px; }
        
        .chat-body {
            flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;
            scroll-behavior: smooth;
        }
        /* Modern Scrollbar */
        .chat-body::-webkit-scrollbar { width: 6px; }
        .chat-body::-webkit-scrollbar-track { background: transparent; }
        .chat-body::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        .chat-body::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }

        .chat-msg {
            max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 0.9rem; line-height: 1.4;
            position: relative; word-wrap: break-word;
        }
        .msg-sent { background: var(--primary); color: #0f172a; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-received { background: #334155; color: white; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        .typing-indicator { font-size: 0.75rem; color: var(--text-muted); align-self: flex-start; margin-left: 10px; display: none; }
        
        .chat-input-area {
            padding: 15px; background: #1e293b; border-top: 1px solid var(--border);
            display: flex; gap: 10px;
        }
        .chat-input {
            flex: 1; background: #0f172a; border: 1px solid var(--border); color: white;
            padding: 10px; border-radius: 20px; outline: none; transition: 0.2s;
        }
        .chat-input:focus { border-color: var(--primary); }
        .chat-send-btn {
            background: var(--primary); color: #0f172a; border: none; width: 40px; height: 40px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .chat-send-btn:hover { transform: scale(1.1); }
        
        /* Floating Toggle Button (Facebook Style Tab) */
        .chat-fab {
            position: fixed !important; bottom: 0; right: 20px !important; left: auto !important;
            width: 280px !important; height: 45px;
            padding: 0 20px;
            background: var(--primary); color: #0f172a;
            border-radius: 8px 8px 0 0;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            cursor: pointer; z-index: 1500;
            font-size: 1rem; font-weight: 700;
            border: none; transition: 0.2s;
        }
        .chat-fab:hover { height: 50px; }
        
        .wa-link {
            display: flex; align-items: center; justify-content: center;
            width: 36px; height: 36px;
            background: rgba(37, 211, 102, 0.1);
            border: 1px solid rgba(37, 211, 102, 0.2);
            border-radius: 50%;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        .wa-link:hover {
            background: rgba(37, 211, 102, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
        }
        .wa-link svg {
            width: 20px; height: 20px; fill: #25D366; 
            filter: drop-shadow(0 0 5px rgba(37,211,102,0.4));
        }

        /* Highlight Animation for New Messages */
        .msg-new-highlight { animation: glow-msg 5s forwards; }
        @keyframes glow-msg { 0% { box-shadow: 0 0 15px var(--primary); border: 1px solid var(--primary); } 100% { box-shadow: none; border-color: transparent; } }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        /* --- GLOBAL SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.25); }

        .chat-badge {
            position: absolute; top: -5px; right: -5px;
            background: #ef4444; color: white;
            border-radius: 50%; width: 20px; height: 20px;
            font-size: 12px; display: flex; align-items: center; justify-content: center;
            font-weight: bold; border: 2px solid #0f172a;
            display: none;
            box-shadow: 0 0 5px rgba(239,68,68, 0.5);
        }
        .highlight-chat {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* --- ANIMATIONS (BoloHi Style) --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes ripple-effect { to { transform: scale(4); opacity: 0; } }
        @keyframes pulse-soft { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        /* Classes */
        .anim-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .anim-stagger-1 { animation-delay: 0.1s; }
        .anim-stagger-2 { animation-delay: 0.2s; }
        .anim-stagger-3 { animation-delay: 0.3s; }
        
        .pulse-active { animation: pulse-soft 2s infinite; }
        
        .glass-shimmer {
            position: relative; overflow: hidden;
        }
        .glass-shimmer::after {
            content: ""; position: absolute; top: 0; left: 0; width: 200%; height: 100%;
            background: linear-gradient(to right, transparent 0%, rgba(255,255,255,0.05) 50%, transparent 100%);
            background-size: 200% 100%; animation: shimmer 3s infinite linear; pointer-events: none;
        }

        /* Ripple Button */
        .ripple-btn { position: relative; overflow: hidden; transform: translate3d(0,0,0); }
        .ripple-span {
            position: absolute; border-radius: 50%; background: rgba(255, 255, 255, 0.3);
            transform: scale(0); animation: ripple-effect 0.6s linear; pointer-events: none;
        }

        @media (max-width: 900px) {
            .profile-container { grid-template-columns: 1fr; }
            .hero-stats { flex-wrap: wrap; justify-content: center; gap: 15px; }
            .stat-item { flex: 1 1 140px; }
            .tabs { width: 100%; overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
            .header { padding: 10px 15px; flex-wrap: wrap; gap: 10px; }
            .header .brand { font-size: 1.2rem; }
            .header > div { gap: 10px; } /* Gap between right-side items */
            
            /* Tabs Mobile Polish */
            .tabs { 
                width: 100%; overflow-x: auto; white-space: nowrap; padding: 5px; 
                scrollbar-width: none; /* Firefox */
                -ms-overflow-style: none; /* IE/Edge */
                mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent); /* Fade edges */
                -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
            }
            .tabs::-webkit-scrollbar { display: none; }
            
            .container { padding: 15px; }
            .modal { width: 90%; padding: 25px; }
            .card-top { flex-direction: column; align-items: flex-start; gap: 15px; }
            .card-top .status-badge { align-self: flex-start; }
            .chat-fab { right: 15px !important; bottom: 85px !important; width: 60px !important; height: 60px !important; border-radius: 50% !important; display: flex; align-items: center; justify-content: center; padding: 0 !important; }
            .chat-fab span:not(.notification-badge) { display: none; } /* Hide text on mobile */
            .chat-fab svg { margin: 0 !important; width: 32px; height: 32px; }
            .chat-widget { right: 0; bottom: 0; width: 100%; height: 100%; border-radius: 0; }
        }
        /* Custom Alert Modal */
        .alert-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .alert-box { background: #1e293b; color: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 350px; text-align: center; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 40px rgba(0,0,0,0.4); transform: scale(0.9); transition: 0.2s; }
        .alert-box.show { transform: scale(1); }
        .alert-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
        .alert-btn { background: var(--primary, #3b82f6); color: white; border: none; padding: 10px 25px; border-radius: 8px; font-weight: 600; margin-top: 20px; cursor: pointer; width: 100%; }

        /* WhatsApp Button Fix */
        .chat-fab .whatsapp-icon {
             width: 32px; height: 32px; fill: white !important; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        
        /* Chat Header WhatsApp Icon */
        .wa-link svg { 
            width: 28px; height: 28px; fill: white !important; 
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
            transition: transform 0.2s;
        }
        .wa-link:hover svg { transform: scale(1.1); }

        /* LEADERBOARD CSS */
        .leaderboard-item { display:flex; align-items:center; justify-content:space-between; padding:10px; background:rgba(255,255,255,0.03); border-radius:8px; }
        .rank-badge { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:800; color:#1e293b; margin-right:10px; font-size:0.9rem; }
        .rank-1 { background: linear-gradient(135deg, #FFD700, #FDB931); box-shadow:0 0 10px rgba(255, 215, 0, 0.4); }
        .rank-2 { background: linear-gradient(135deg, #E0E0E0, #BDBDBD); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #A0522D); }
        .rank-other { background: rgba(255,255,255,0.1); color:white; }

        @media (max-width: 900px) {
            #tab-active { grid-template-columns: 1fr !important; }
            #leaderboardSection { order: -1; } /* Show Leaderboard on top on mobile? Or bottom? Let's say bottom or just implicit order */
        }
        
        /* EMPTY STATES */
        .hero-empty {
            text-align: center;
            padding: 60px 40px;
            background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            border-radius: 20px;
            border: 1px dashed rgba(255,255,255,0.1);
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .hero-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.8; animation: float 3s ease-in-out infinite; }
        .hero-title { font-size: 2rem; margin: 0 0 10px 0; background: linear-gradient(to right, white, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hero-sub { color: var(--text-muted); font-size: 1.1rem; max-width: 500px; margin: 0 0 30px 0; line-height: 1.6; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        
        /* Stats in Empty State */
        .hero-stats { display: flex; gap: 40px; margin-bottom: 40px; }
        .stat-item { text-align: center; }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: white; display: block; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        .status-ready { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.4); box-shadow: 0 0 10px rgba(59, 130, 246, 0.2); animation: pulse-soft 2s infinite; }
        .pulse-btn { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body>
    <!-- Custom Alert HTML -->
    <div id="customAlert" class="alert-overlay">
        <div class="alert-box" id="alertBox">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <h3 id="alertTitle" style="margin:0 0 10px 0;">Notice</h3>
            <p id="alertMsg" style="color: #94a3b8; margin:0; line-height: 1.5;">...</p>
            <button class="alert-btn" onclick="closeCustomAlert()">OK</button>
        </div>
    </div>

    <div class="ambient-glow"></div>
    <div id="toast">‚úÖ Notification</div>


    <header class="header">
        <div class="brand">MED DATA</div>
        <div style="display:flex; align-items:center; gap:20px;">


            <div class="wallet-pill" id="streakDisplay" style="background:rgba(234, 179, 8, 0.1); color:#facc15; border-color:rgba(234, 179, 8, 0.2); display:none;">üî• 0 Days</div>
            
            <!-- WALLET DROPDOWN CONTAINER -->
            <div style="position:relative;">
                <div class="wallet-pill" id="walletDisplay" onclick="toggleWalletDropdown()">...</div>
                <div id="walletDropdown" style="display:none; position:absolute; top:120%; right:0; width:300px; background:#1e293b; border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:15px; z-index:100; box-shadow:0 10px 40px rgba(0,0,0,0.5);">
                    <h4 style="margin:0 0 10px 0; color:white; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:8px;">Recent Activity</h4>
                    <div id="walletDropdownList" style="max-height:200px; overflow-y:auto;"></div>
                    <div style="margin-top:10px; text-align:center;">
                        <button onclick="switchTab('withdrawals'); toggleWalletDropdown();" style="background:none; border:none; color:var(--primary); font-size:0.8rem; cursor:pointer; text-decoration:underline;">View Full History</button>
                    </div>
                </div>
            </div>

            <button onclick="logout()" style="background:transparent; border:none; color:var(--danger); font-weight:600; cursor:pointer; font-size:0.9rem;">Sign Out</button>
        </div>
    </header>

    <main class="container">
        
        <!-- Welcome Header -->
        <div id="welcomeHeader" style="margin-bottom: 30px; display:none;">
            <h1 style="margin:0; font-size:1.8rem;">Hello, <span id="userNameDisplay" style="color:var(--primary);">User</span> üëã</h1>
            <p style="color:var(--text-muted); margin-top:5px;">Here is your workstation overview.</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active ripple-btn" onclick="switchTab('active', this)">Active Work</button>
            <button class="tab-btn ripple-btn" onclick="switchTab('history', this)">History</button>
            <button class="tab-btn ripple-btn" onclick="switchTab('withdrawals', this)">Finance</button>
            <button class="tab-btn ripple-btn" onclick="switchTab('certifications', this)">Certifications</button>
            <button class="tab-btn ripple-btn" onclick="switchTab('analytics', this)">Analytics</button>
            <button class="tab-btn ripple-btn" onclick="switchTab('community', this)">Community</button>
            <button class="tab-btn ripple-btn" onclick="switchTab('profile', this)">My Profile</button>
        </div>

        <!-- Active View -->
        <!-- Active Work Tab -->
        <div id="tab-active" class="view slide-in" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:25px;">
            <div style="grid-column: 1/-1;">
                 <div class="hero-sub" id="welcomeHeader" style="display:none;">Here is your workstation overview.</div>
    
                 <!-- KYC BANNER -->
                 <div id="kycBanner" style="display:none; background:linear-gradient(90deg, #f59e0b, #d97706); color:black; padding:15px; margin-bottom:30px; border-radius:12px; align-items:center; justify-content:space-between; box-shadow:0 4px 15px rgba(245, 158, 11, 0.3);">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:1.2rem;">‚ö†Ô∏è</span>
                        <div style="font-weight:700; font-size:0.95rem;">Action Required: Complete your KYC to enable certifications & payouts.</div>
                    </div>
                    <button onclick="switchTab('profile', document.querySelectorAll('.tab-btn')[5])" style="background:black; color:white; border:none; padding:8px 20px; border-radius:8px; cursor:pointer; font-weight:700; box-shadow:0 2px 10px rgba(0,0,0,0.2);">Verify Now &rarr;</button>
                 </div>
            </div>


            <!-- QUICK STATS ROW -->
            <div style="grid-column: 1/-1; display:flex; gap:20px; flex-wrap:wrap; margin-bottom:10px;">
                 <div class="card" style="flex:1; padding:20px; min-width:200px; display:flex; align-items:center; gap:15px; background:linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05)); border:1px solid rgba(59, 130, 246, 0.2);">
                     <div style="font-size:2rem;">üí∞</div>
                     <div>
                         <div style="font-size:0.85rem; color:var(--text-muted); text-transform:uppercase; font-weight:600;">Wallet Balance</div>
                         <div style="font-size:1.5rem; font-weight:700; color:white;">‚Çπ <span id="statWalletBal">...</span></div>
                     </div>
                 </div>
                 <div class="card" style="flex:1; padding:20px; min-width:200px; display:flex; align-items:center; gap:15px;">
                     <div style="font-size:2rem;">üìÇ</div>
                     <div>
                         <div style="font-size:0.85rem; color:var(--text-muted); text-transform:uppercase; font-weight:600;">Active Tasks</div>
                         <div style="font-size:1.5rem; font-weight:700; color:white;" id="statActiveCount">0</div>
                     </div>
                 </div>
            </div>

            <!-- MAIN GRID: Left (Projects) | Right (Sidebar) -->
            <div style="grid-column: 1/-1; display:grid; grid-template-columns: 3fr 1fr; gap:30px;">
                
                <!-- LEFT COLUMN: Work Feed -->
                <div style="display:flex; flex-direction:column; gap:20px;">
                     <h3 style="margin:0; color:white; font-size:1.2rem; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
                        üìå Assigned Projects
                     </h3>
                     <div id="projectListSection" style="display:flex; flex-direction:column; gap:15px;"></div>
                </div>

                <!-- RIGHT COLUMN: Sidebar -->
                <div style="display:flex; flex-direction:column; gap:20px;">
                    
                    <!-- GAMIFICATION CARD -->
                    <div style="background:rgba(255,255,255,0.05); border-radius:15px; padding:20px; border:1px solid rgba(255,255,255,0.1);">
                        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:15px;">
                             <div>
                                 <div style="text-transform:uppercase; letter-spacing:1px; font-size:0.75rem; color:var(--text-muted); margin-bottom:5px;">Current Rank</div>
                                 <div style="font-size:1.5rem; font-weight:700; background: linear-gradient(to right, #facc15, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent;" id="g-title">Loading...</div>
                             </div>
                             <div style="text-align:right;">
                                 <div style="font-size:0.8rem; color:var(--text-muted);">Level <span id="g-level">0</span></div>
                             </div>
                        </div>
                        
                        <div style="height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden; margin-bottom:5px;">
                            <div id="g-progress" style="height:100%; width:0%; background:linear-gradient(to right, #facc15, #f59e0b); transition: width 1s ease;"></div>
                        </div>
                        <div style="font-size:0.8rem; text-align:right; color:var(--text-muted);" id="g-xp-text">0 / 0 XP</div>
                    </div>

                    <!-- LEADERBOARD WIDGET -->
                    <div class="card" style="padding:20px; max-height:400px; display:flex; flex-direction:column;">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:15px;font-weight:700; color:var(--primary); border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
                             <span>üèÜ</span> TOP PERFORMERS
                        </div>
                        <div id="leaderboardList" style="overflow-y:auto; padding-right:5px;">
                             <!-- Content populated by JS -->
                        </div>
                    </div>
                    
                    <!-- CHALLENGE WIDGET CONTAINER -->
                    <div id="challengeContainer" style="display:flex; flex-direction:column; gap:15px;"></div>
                </div>
            </div>

        </div>

        <!-- History View -->
        <section id="tab-history" class="view grid" style="display:none;"></section>

        <!-- Withdrawals View -->
        <!-- Withdrawals View -->
        <section id="tab-withdrawals" class="view" style="display:none; width:100%; max-width:1200px; margin:0 auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
                 <div>
                     <h2 style="color:white; margin:0; font-size:1.8rem;">Finance & Payouts</h2>
                     <p style="margin:5px 0 0 0; color:var(--text-muted); font-size:0.9rem;">Manage your wallet, view history, and request withdrawals.</p>
                 </div>
                 <button class="btn btn-primary ripple-btn" style="width:auto; padding:8px 20px; margin:0; font-size:0.9rem; display:flex; align-items:center; gap:8px;" onclick="openWithdrawModal()">
                    <span>üí∏</span> Request Payout
                 </button>
             </div>

            <div class="card">
                <div id="withdrawalList" style="display:flex; flex-direction:column; gap:15px;"></div>
            </div>
        </section>

        <!-- Certifications Tab -->
        <!-- Certifications Tab -->
        <div id="tab-certifications" class="view slide-in" style="display:none; width:100%; max-width:1200px; margin:0 auto;">
             <div style="margin-bottom:30px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
                 <h2 style="color:white; margin:0; font-size:1.8rem;">Skill Certifications</h2>
                 <p style="margin:5px 0 0 0; color:var(--text-muted); font-size:0.9rem;">Earn badges and unlock higher pay rates by verifying your skills.</p>
             </div>
             
             <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap:20px;">
                 <div class="card" style="display:flex; gap:20px; align-items:center;">
                    <div style="width:60px; height:60px; background:rgba(59, 130, 246, 0.1); color:#60a5fa; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.8rem; flex-shrink:0;">ü©∫</div>
                    <div style="flex:1;">
                        <h3 style="margin:0 0 5px 0; font-size:1.1rem;">Medical Terminology</h3>
                        <p style="margin:0 0 10px 0; color:var(--text-muted); font-size:0.85rem;">Verify your knowledge of medical terms and abbreviations.</p>
                        <div style="font-size:0.8rem; color:#10b981; font-weight:600;">‚ú® Reward: +20% Salary</div>
                        <button class="btn btn-primary" style="margin-top:15px; padding:8px;" onclick="startCertTest('medical_coding')">Start Test</button>
                    </div>
                 </div>

                 <div class="card" style="display:flex; gap:20px; align-items:center;">
                    <div style="width:60px; height:60px; background:rgba(234, 179, 8, 0.1); color:#facc15; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.8rem; flex-shrink:0;">‚å®Ô∏è</div>
                    <div style="flex:1;">
                        <h3 style="margin:0 0 5px 0; font-size:1.1rem;">Typing Speed (60+ WPM)</h3>
                        <p style="margin:0 0 10px 0; color:var(--text-muted); font-size:0.85rem;">Prove your transcription speed and accuracy.</p>
                        <button class="btn btn-outline" style="margin-top:15px; padding:8px;" onclick="startCertTest('typing_test')">Take Test</button>
                    </div>
                 </div>

                 <div class="card" style="display:flex; gap:20px; align-items:center;">
                    <div style="width:60px; height:60px; background:rgba(168, 85, 247, 0.1); color:#a855f7; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.8rem; flex-shrink:0;">üîí</div>
                    <div style="flex:1;">
                        <h3 style="margin:0 0 5px 0; font-size:1.1rem;">HIPAA Compliance</h3>
                        <p style="margin:0 0 10px 0; color:var(--text-muted); font-size:0.85rem;">Essential for handling sensitive patient data.</p>
                        <div style="margin-top:15px; color:var(--text-muted); font-weight:700; font-size:0.85rem;">COMING SOON</div>
                    </div>
                 </div>
             </div>
        </div>

        <!-- Analytics Tab (Refined Layout) -->
        <div id="tab-analytics" class="view slide-in" style="display:none; width:100%; max-width:1200px; margin:0 auto;">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
                 <div>
                     <h2 style="color:white; margin:0; font-size:1.8rem;">Personal Analytics</h2>
                     <p style="margin:5px 0 0 0; color:var(--text-muted); font-size:0.9rem;">Track your performance and earnings over time.</p>
                 </div>
                 <button class="btn btn-outline ripple-btn" style="width:auto; padding:8px 20px; margin:0; font-size:0.85rem;" onclick="loadAnalytics()">
                    üîÑ Refresh
                 </button>
             </div>
             
             <!-- Metrics Grid -->
             <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:20px; margin-bottom:30px;">
                 <div class="card" style="text-align:center; padding:25px; position:relative; overflow:hidden;">
                     <div style="position:absolute; top:0; left:0; width:100%; height:4px; background:#10b981;"></div>
                     <div style="color:var(--text-muted); font-size:0.85rem; margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:1px;">30 Day Earnings</div>
                     <div style="font-size:2.2rem; font-weight:800; color:#10b981;" id="anaEarnings">‚Çπ0</div>
                 </div>
                 <div class="card" style="text-align:center; padding:25px; position:relative; overflow:hidden;">
                     <div style="position:absolute; top:0; left:0; width:100%; height:4px; background:#facc15;"></div>
                     <div style="color:var(--text-muted); font-size:0.85rem; margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:1px;">Avg Quality Score</div>
                     <div style="font-size:2.2rem; font-weight:800; color:#facc15;" id="anaQuality">0.0</div>
                 </div>
                 <div class="card" style="text-align:center; padding:25px; position:relative; overflow:hidden;">
                     <div style="position:absolute; top:0; left:0; width:100%; height:4px; background:#38bdf8;"></div>
                     <div style="color:var(--text-muted); font-size:0.85rem; margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:1px;">Speed Percentile</div>
                     <div style="font-size:2.2rem; font-weight:800; color:#38bdf8;" id="anaSpeed">0%</div>
                     <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px; font-style:italic;" id="anaSpeedText">Calculating...</div>
                 </div>
             </div>
             
             <!-- Charts Grid -->
             <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:25px;">
                 <div class="card" style="padding:25px;">
                     <h3 style="margin:0 0 20px 0; color:white; font-size:1.1rem; display:flex; align-items:center; gap:8px;">
                        <span>üìà</span> Earnings Trend
                     </h3>
                     <div style="position:relative; height:300px; width:100%;">
                        <canvas id="chartEarnings"></canvas>
                     </div>
                 </div>
                 
                 <div class="card" style="padding:25px;">
                     <h3 style="margin:0 0 20px 0; color:white; font-size:1.1rem; display:flex; align-items:center; gap:8px;">
                        <span>üéØ</span> Quality History
                     </h3>
                     <div style="position:relative; height:300px; width:100%;">
                        <canvas id="chartQuality"></canvas>
                     </div>
                 </div>
             </div>
        </div>



        <!-- Community Tab -->
        <div id="tab-community" class="view slide-in" style="display:none; width:100%; padding: 0 20px;">
             <!-- Header - Professional Theme -->
             <div style="margin-bottom:30px; padding:25px 30px; background:linear-gradient(135deg, rgba(56, 189, 248, 0.1), rgba(168, 85, 247, 0.1)); border-radius:20px; border:1px solid rgba(56, 189, 248, 0.2); position:relative; overflow:hidden;">
                 <h2 style="color:white; margin:0; font-size:1.8rem; font-weight:700; position:relative; z-index:1; display:flex; align-items:center; gap:12px;">
                    <span style="font-size:2rem;">üë•</span> Community Hub
                 </h2>
                 <p style="margin:8px 0 0 0; color:var(--text-muted); font-size:0.95rem; position:relative; z-index:1;">Connect, share wins, and learn from fellow data specialists.</p>
             </div>
             
             <!-- Create Post Box - Enhanced -->
             <div style="margin-bottom:30px; padding:25px; background:#1e293b; border-radius:16px; border:1px solid #334155; transition: all 0.3s ease; box-shadow:0 4px 30px rgba(0,0,0,0.3);">
                 <div style="display:flex; gap:15px;">
                     <div style="width:48px; height:48px; border-radius:50%; background:linear-gradient(135deg, #38bdf8, #a855f7); display:flex; align-items:center; justify-content:center; font-size:1.3rem; flex-shrink:0; box-shadow:0 0 15px rgba(56, 189, 248, 0.4);">üë§</div>
                     <div style="flex:1;">
                         <textarea id="postContent" placeholder="What's on your mind? Share achievements, tips, or ask for help..." style="width:100%; background:rgba(0,0,0,0.3); border:1px solid #475569; color:white; padding:15px; border-radius:12px; resize:none; min-height:100px; font-family:inherit; font-size:0.95rem; transition:all 0.3s;" onfocus="this.style.borderColor='#38bdf8'; this.style.boxShadow='0 0 15px rgba(56, 189, 248, 0.2)';" onblur="this.style.borderColor='#475569'; this.style.boxShadow='none';"></textarea>
                         <div style="display:flex; justify-content:flex-end; align-items:center; margin-top:15px;">
                             <div id="postCharCount" style="color:var(--text-muted); font-size:0.8rem; margin-right:15px;">0/500</div>
                             <button id="postBtn" class="btn btn-primary ripple-btn" style="padding:10px 30px; margin:0; font-weight:600; box-shadow:0 4px 15px rgba(56, 189, 248, 0.4);" onclick="createPost()" disabled>
                                 <span style="display:flex; align-items:center; gap:8px;">‚ú® Post Update</span>
                             </button>
                         </div>
                     </div>
                 </div>
             </div>
             
             <!-- Feed Container -->
             <div id="postFeed" style="display:flex; flex-direction:column; gap:20px;">
                 <div style="text-align:center; color:var(--text-muted); padding:40px;">
                     <div class="loading-spinner"></div>
                     <div style="margin-top:15px;">Loading community posts...</div>
                 </div>
             </div>
        </div>
        
        <style>
            @keyframes pulseGlow {
                0%, 100% { opacity: 0.5; transform: scale(1); }
                50% { opacity: 1; transform: scale(1.05); }
            }
            @keyframes btnPulse {
                0%, 100% { box-shadow: 0 0 10px rgba(56, 189, 248, 0.3); }
                50% { box-shadow: 0 0 25px rgba(56, 189, 248, 0.6); }
            }
            @keyframes slideInUp {
                from { opacity: 0; transform: translateY(30px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .loading-spinner {
                width: 40px; height: 40px; margin: 0 auto;
                border: 3px solid rgba(255,255,255,0.1);
                border-top-color: #38bdf8;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            @keyframes spin { to { transform: rotate(360deg); } }
            
            #postFeed > div {
                animation: slideInUp 0.4s ease-out;
            }
            #postFeed > div:nth-child(2) { animation-delay: 0.1s; }
            #postFeed > div:nth-child(3) { animation-delay: 0.2s; }
            #postFeed > div:nth-child(4) { animation-delay: 0.3s; }
            #postFeed > div:nth-child(5) { animation-delay: 0.4s; }
        </style>



        <!-- Profile View -->
        <section id="tab-profile" class="view" style="display:none;">
            <div class="profile-container">
                <!-- REFERRAL CARD -->
                 <div class="card" style="grid-column:1/-1; background:linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(168, 85, 247, 0.2)); border:1px solid rgba(139, 92, 246, 0.3); margin-bottom:20px; text-align:left;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h3 style="margin:0 0 5px 0;">Refer & Earn ‚Çπ500</h3>
                            <p style="margin:0; font-size:0.9rem; color:#e2e8f0;">Invite friends to join MedData! Bonus credited on their first payout.</p>
                            <div style="margin-top:15px; font-weight:700; font-size:1.1rem; font-family:monospace; background:rgba(0,0,0,0.3); display:inline-block; padding:8px 15px; border-radius:8px; cursor:pointer;" onclick="copyReferral()">
                                CODE: <span id="refCodeDisplay" style="color:#a5b4fc;">...</span> üìã
                            </div>
                        </div>
                        <div style="font-size:3rem;">üéÅ</div>
                    </div>
                </div>

                <!-- KYC CARD -->
                <div class="card" style="grid-column:1/-1; border:1px solid rgba(255,255,255,0.1); margin-bottom:20px;">
                     <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                         <div>
                             <h3 style="margin:0 0 5px 0; color:white;">Identity Verification (KYC)</h3>
                             <p style="margin:0; font-size:0.85rem; color:var(--text-muted);">Government ID (Aadhar & PAN) is required for tax & payout compliance.</p>
                         </div>
                         <span id="kycStatusBadge" class="status-badge" style="background:rgba(255,255,255,0.1); color:var(--text-muted);">NOT UPLOADED</span>
                     </div>
                     
                     <div id="kycUploadSection" style="margin-top:20px; padding-top:20px; border-top:1px solid rgba(255,255,255,0.05); display:none;">
                         <div class="input-grid" style="grid-template-columns: 1fr 1fr;">
                             <div class="input-wrap">
                                 <label>Aadhar Card (Front)</label>
                                 <input type="file" id="kycAadhar" accept="image/*,application/pdf" style="padding:12px; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:8px; color:white; width:100%;">
                             </div>
                             <div class="input-wrap">
                                 <label>PAN Card (Front)</label>
                                 <input type="file" id="kycPan" accept="image/*,application/pdf" style="padding:12px; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:8px; color:white; width:100%;">
                             </div>
                         </div>
                         <div style="text-align:right; margin-top:20px;">
                            <button class="btn btn-primary ripple-btn" onclick="submitKYC()" style="width:auto; padding:10px 30px;">Submit Documents üîí</button>
                         </div>
                     </div>

                     <div id="kycRejectionMsg" style="margin-top:15px; background:rgba(239,68,68,0.1); color:#ef4444; padding:15px; border-radius:8px; display:none; border:1px solid rgba(239,68,68,0.3);">
                         <strong>‚ùå Verification Failed:</strong> <span id="kycRejectReason">Document unclear.</span> <br>
                         <span style="font-size:0.85rem; opacity:0.8;">Please re-upload clear images.</span>
                     </div>
                </div>

                <div class="profile-card">
                    <img id="userAvatar" src="/static/default-avatar.png" class="avatar-glow" onerror="this.src='https://ui-avatars.com/api/?name=User'">
                    <h2 id="profileName" style="margin:0 0 5px 0;">...</h2>
                    <p id="profileCode" style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">EMPLOYEE</p>
                    
                    <label class="btn btn-outline" style="font-size:0.9rem; padding:10px;">
                        Change Picture <input type="file" id="picInput" hidden onchange="uploadPic()">
                    </label>
                </div>

                <form id="profileForm" class="form-section" onsubmit="updateProfile(event)">
                    <div style="display:flex; justify-content:space-between; margin-bottom:30px; align-items:center;">
                        <h3 style="margin:0;">Personal Details</h3>
                        <button type="button" id="editBtn" onclick="toggleEdit(true)" style="background:none; border:none; color:var(--primary); font-weight:700; cursor:pointer;">EDIT DETAILS</button>
                    </div>
                    
                    <div class="input-grid">
                        <div class="input-wrap"><label>Full Name</label><input name="full_name" disabled></div>
                        <div class="input-wrap"><label>Email Address</label><input name="email" disabled></div>
                        <div class="input-wrap"><label>Mobile Number</label><input name="mobile" disabled></div>
                        <div class="input-wrap"><label>Address</label><input name="address" disabled></div>
                    </div>

                    <div style="margin: 40px 0 20px 0; height:1px; background:var(--glass-border);"></div>

                    <div style="display:flex; justify-content:space-between; margin-bottom:30px;">
                        <h3 style="margin:0;">Banking Information <span style="font-size:0.8rem; color:var(--text-muted); font-weight:400; margin-left:10px;">(Encrypted)</span></h3>
                    </div>

                    <div class="input-grid">
                        <div class="input-wrap"><label>Account Holder</label><input name="bank_holder_name" disabled></div>
                        <div class="input-wrap"><label>Account Number</label><input name="bank_account_number" disabled type="password" onfocus="this.type='text'" onblur="this.type='password'"></div>
                        <div class="input-wrap"><label>IFSC Code</label><input name="ifsc_code" disabled></div>
                        <div class="input-wrap"><label>Bank Name</label><input name="bank_name" disabled></div>
                    </div>

                    <div id="saveActions" style="display:none; text-align:right; margin-top:30px; padding-top:20px; border-top:1px solid rgba(255,255,255,0.05);">
                        <button type="button" onclick="toggleEdit(false)" style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:var(--text-muted); margin-right:15px; cursor:pointer; font-weight:600; padding:10px 25px; border-radius:8px;">CANCEL</button>
                        <button type="submit" class="btn btn-primary ripple-btn" style="width:auto; display:inline-block; padding:10px 30px; box-shadow:0 4px 15px rgba(56, 189, 248, 0.4);">SAVE CHANGES üíæ</button>
                    </div>
                </form>
            </div>
        </section>
    </main>

    <div id="walletModal" class="modal-overlay">
        <div class="modal" style="width:500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">Wallet History</h2>
                <button style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;" onclick="document.getElementById('walletModal').style.display='none'">&times;</button>
            </div>
            
            <div id="walletList" style="max-height:400px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;">
                 <!-- History Items -->
                 <div style="text-align:center; padding:20px; color:var(--text-muted);">Loading transactions...</div>
            </div>
        </div>
    </div>
    
    <!-- Payout Modal -->
    <div id="withdrawModal" class="modal-overlay">
        <div class="modal">
            <h2 style="margin-top:0;">Request Payout</h2>
            <p style="color:var(--text-muted); font-size:0.95rem; line-height:1.5;">Available funds will be transferred to your linked bank account within 24 hours.</p>
            
            <div style="background:rgba(0,0,0,0.2); padding:20px; border-radius:12px; margin:25px 0; border:1px solid var(--glass-border);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <label style="font-weight:600; font-size:0.8rem; color:var(--text-muted); margin:0;">WITHDRAWAL AMOUNT (‚Çπ)</label>
                    <div style="font-size:0.8rem; color:var(--text-muted);">
                        Available: <span style="color:#10b981; font-weight:700;" id="modalWalletBal">‚Çπ0</span>
                        <button type="button" onclick="setMaxWithdrawal()" style="background:none; border:none; color:var(--primary); font-weight:700; cursor:pointer; margin-left:10px;">MAX</button>
                    </div>
                </div>
                
                <input type="number" id="withdrawAmount" placeholder="Min ‚Çπ500" style="width:100%; padding:15px; background:#0f172a; border:1px solid #334155; color:white; border-radius:12px; font-size:1.5rem; outline:none; font-weight:700; font-family:monospace;" oninput="updatePayoutEst()">
                
                <div style="margin-top:20px; display:flex; gap:10px; align-items:flex-start;">
                    <input type="checkbox" id="withdrawInstant" style="margin-top:5px; transform:scale(1.2); accent-color:#facc15;" onchange="updatePayoutEst()">
                    <div style="flex:1;">
                        <div style="font-weight:600; color:#facc15; display:flex; align-items:center; gap:5px;">
                            <span>‚ö° Instant Payout</span>
                            <span style="font-size:0.7rem; background:rgba(250,204,21,0.2); padding:2px 6px; border-radius:4px;">FAST</span>
                        </div>
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-top:3px; line-height:1.4;">
                            Get funds in 15 mins. A 2% convenience fee applies.
                        </div>
                    </div>
                </div>
                
                <div id="payoutEst" style="margin-top:20px; border-top:1px dashed rgba(255,255,255,0.1); padding-top:15px; display:none; justify-content:space-between; font-size:1rem; align-items:center;">
                    <span style="color:var(--text-muted);">You receive:</span>
                    <span style="font-weight:700; color:#10b981; font-size:1.2rem;" id="payoutFinalAmt">‚Çπ0</span>
                </div>
            </div>

            <div style="display:flex; gap:15px;">
                <button onclick="document.getElementById('withdrawModal').style.display='none'" class="btn btn-outline">Cancel</button>
                <button onclick="submitWithdrawal()" class="btn btn-primary">Confirm Request</button>
            </div>
        </div>
    </div>

    <script>
        const currentUser = JSON.parse(localStorage.getItem('user'));
        // Admin Redirect
        if(currentUser && (currentUser.role === 'ADMIN' || currentUser.username === 'Rohit')) {
            window.location.replace('/admin/dashboard');
        }

        let userId = currentUser ? (currentUser.id || currentUser.uid) : null;
        window.userId = userId; // Make accessible to chat widget
        let userProfile = {}; 

        // --- AUTH UTILS ---
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            window.location.href = "/";
        }

        // ... (existing fetchSecure) ...

        // --- WORKFLOW FUNCTIONS ---
        function startWork(projectId) {
             // Set localStorage values needed by workstation (dashboard.html)
             localStorage.setItem('user_id', userId);
             localStorage.setItem('current_project_id', projectId);
             localStorage.setItem('token', localStorage.getItem('access_token')); // Dashboard uses 'token'
             
             // Redirect to workstation page (dashboard.html)
             window.location.href = `/dashboard?project=${projectId}`;
        }

        async function submitBatch(projectId) {
            if(!confirm("Are you sure you want to submit this batch for review? You cannot edit it afterwards.")) return;
            
            try {
                const res = await fetchSecure('/api/projects/finalize', {
                    method: 'POST',
                    body: JSON.stringify({ project_id: projectId, employee_id: userId })
                });
                
                if(res.ok) {
                    showToast("Batch Submitted Successfully! üöÄ");
                    triggerConfetti();
                    loadData(); // Refresh lists
                } else {
                    showToast("Submission Failed");
                }
            } catch(e) { console.error(e); showToast("Error submitting batch"); }
        }

        // ... (renderHistory logic fix) ...
        // We will target the specific renderHistory block in a separate replace call or this one if contiguous.
        // Since renderHistory is further down (around 1590 in original file, but here I'm replacing script top? No, `startWork` isn't at script top.)
        // I should stick to replacing the specific blocks.
        


        async function fetchSecure(url, options = {}) {
            const token = localStorage.getItem('access_token');
            if(!token) {
                window.location.href = "/";
                return null;
            }
            if(!options.headers) options.headers = {};
            options.headers['Authorization'] = `Bearer ${token}`;
            
            // Auto-detect JSON
            if(options.body && typeof options.body === 'string' && !options.headers['Content-Type']) {
                try {
                    JSON.parse(options.body);
                    options.headers['Content-Type'] = 'application/json';
                } catch(e) {}
            }
            
            const res = await fetch(url, options);
            if(res.status === 401 || res.status === 403) {
                logout();
                return null;
            }
            return res;
        } 
        
        // --- ANIMATIONS ---
        
        // 1. Ripple Effect Listener
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('ripple-btn') || e.target.closest('.ripple-btn')) {
                const button = e.target.classList.contains('ripple-btn') ? e.target : e.target.closest('.ripple-btn');
                const circle = document.createElement('span');
                const diameter = Math.max(button.clientWidth, button.clientHeight);
                const radius = diameter / 2;
                
                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${e.clientX - button.getBoundingClientRect().left - radius}px`;
                circle.style.top = `${e.clientY - button.getBoundingClientRect().top - radius}px`;
                circle.classList.add('ripple-span');
                
                const ripple = button.getElementsByClassName('ripple-span')[0];
                if (ripple) { ripple.remove(); }
                
                button.appendChild(circle);
            }
        });

        // 2. Confetti Effect (Simple CSS-based particles)
        function triggerConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'fixed';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = '-10px';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.background = ['#ff0', '#f00', '#0f0', '#00f', '#f0f'][Math.floor(Math.random() * 5)];
                confetti.style.opacity = Math.random();
                confetti.style.zIndex = '9999';
                confetti.style.pointerEvents = 'none';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                document.body.appendChild(confetti);
                
                const duration = Math.random() * 3 + 2;
                confetti.animate([
                    { transform: `translateY(0) rotate(0)`, opacity: 1 },
                    { transform: `translateY(100vh) rotate(${Math.random() * 720}deg)`, opacity: 0 }
                ], {
                    duration: duration * 1000,
                    easing: 'linear',
                    iterations: 1
                }).onfinish = () => confetti.remove();
            }
        }

        // REMOVED DUPLICATE AUTH & FETCH UTILS


        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerHTML = `‚úÖ ${msg}`;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function logout() { localStorage.clear(); window.location.href="/"; }

        /* --- DATA LOADING --- */
        async function loadGamification() {
            try {
                const res = await fetchSecure('/api/gamification/status');
                if(res && res.ok) {
                    const data = await res.json();
                    document.getElementById('g-title').innerText = data.title;
                    document.getElementById('g-level').innerText = data.level;
                    document.getElementById('g-xp-text').innerText = `${data.xp} / ${data.next_level_xp} XP`;
                    document.getElementById('g-progress').style.width = `${data.progress}%`;
                    
                    // Update Milestones
                    document.querySelectorAll('.milestone').forEach(el => {
                        const lvl = parseInt(el.getAttribute('data-level'));
                        if(lvl <= data.level) el.classList.add('active');
                        else el.classList.remove('active');
                    });
                }
            } catch(e) { console.error("Gamification Load Error", e); }
        }

        async function loadData() {
            if(!userId) return window.location.href = "/";
            
            try {
                // PARALLEL FETCH for Speed
                const [pRes, projectsRes] = await Promise.all([
                    fetchSecure(`/api/employees/me/${userId}`),
                    fetchSecure(`/api/projects/available/${userId}`),
                    loadGamification(), 
                    loadWalletHistory(),
                    loadLeaderboard()
                ]);

                // 1. Process Profile (First, to populate userProfile global)
                if(pRes && pRes.ok) {
                    userProfile = await pRes.json();
                    
                    // Update UI Header
                    const walletDisp = document.getElementById('walletDisplay');
                    if(walletDisp) walletDisp.innerHTML = `‚Çπ ${userProfile.wallet.toLocaleString('en-IN')}`;
                    
                    // Streak
                    if(userProfile.login_streak > 0) {
                        const streakEl = document.getElementById('streakDisplay');
                        if(streakEl) {
                            streakEl.innerText = `üî• ${userProfile.login_streak} Day Streak`;
                            streakEl.style.display = 'block';
                        }
                    }

                    const nameDisp = document.getElementById('userNameDisplay');
                    if(nameDisp) nameDisp.innerText = userProfile.username;
                    const welcomeHeader = document.getElementById('welcomeHeader');
                    if(welcomeHeader) welcomeHeader.style.display = 'block';
                    
                    const pName = document.getElementById('profileName');
                    if(pName) pName.innerText = userProfile.full_name || userProfile.username;
                    
                    const pCode = document.getElementById('profileCode');
                    if(pCode) pCode.innerText = userProfile.code || "EMPLOYEE";
                    
                    const uAvatar = document.getElementById('userAvatar');
                    if(uAvatar) {
                        if(userProfile.profile_pic && !userProfile.profile_pic.includes('default')) {
                            uAvatar.src = userProfile.profile_pic;
                        } else {
                            // Use UI Avatars with Initials
                            uAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(userProfile.full_name || userProfile.username)}&background=6366f1&color=fff&size=128&font-size=0.5`;
                        }
                    }

                    // Render KYC
                    if(typeof renderKYC === 'function') renderKYC(userProfile);
                    
                    // Referral Code (Derived from ID)
                    if(userProfile.id) {
                        const refCode = "REF-" + userProfile.id.substring(0,6).toUpperCase();
                        const refDisp = document.getElementById('refCodeDisplay');
                        if(refDisp) refDisp.innerText = refCode;
                        window.currentUserRefCode = refCode;
                    }

                    // Fill Form
                    const form = document.getElementById('profileForm');
                    if(form) {
                        for (let key in userProfile) { if(form.elements[key]) form.elements[key].value = userProfile[key] || ""; }
                    }
                    
                    // UPDATE NEW DASHBOARD STATS (Quick Stats Row)
                    const statWallet = document.getElementById('statWalletBal');
                    if(statWallet) statWallet.innerText = (userProfile.wallet || 0).toLocaleString();
                }

                // 2. Process Work (After profile, so wallet stats work)
                if(projectsRes && projectsRes.ok) {
                    const projects = await projectsRes.json();
                    renderActiveWork(projects);
                    // renderHistory(projects); // Removed: Handled by dedicated loadProjectHistory on tab switch
                }
                

            } catch(e) {
                console.error("Critical Load Error", e);
                showToast("Connection unstable. Retrying...");
            }
        }

        let leaderboardData = [];
        let shuffleInterval;

        async function loadLeaderboard() {
            const list = document.getElementById('leaderboardList');
            try {
                const res = await fetch('/api/public/leaderboard');
                if(!res.ok) return;
                leaderboardData = await res.json();
                
                renderLeaderboard();
                startShuffle();
            } catch(e) { console.error(e); }
        }

        function renderLeaderboard() {
            const list = document.getElementById('leaderboardList');
            // Internal Scroll Styling
            list.style.maxHeight = "320px";
            list.style.overflowY = "auto";
            list.style.paddingRight = "5px"; // Prevent scroll overlap
            list.innerHTML = "";
            
            // Sort by balance DESC
            leaderboardData.sort((a,b) => b.balance - a.balance);
            
            // Take Top 10 ONLY (as requested)
            const subset = leaderboardData.slice(0, 10);

            if (subset.length === 0) {
                 list.innerHTML = `<div style="text-align:center; padding:30px; color:var(--text-muted); font-size:0.9rem;">No leaderboard data available.</div>`;
                 return;
            }

            subset.forEach((u, idx) => {
                const rankClass = idx === 0 ? 'rank-1' : idx === 1 ? 'rank-2' : idx === 2 ? 'rank-3' : 'rank-other';
                list.innerHTML += `
                    <div class="leaderboard-item" style="transition: all 0.5s ease; margin-bottom:8px;">
                        <div style="display:flex; align-items:center;">
                            <div class="rank-badge ${rankClass}" style="width:24px; height:24px; font-size:0.8rem; margin-right:8px;">${idx+1}</div>
                            <span style="font-weight:600; color:white; font-size:0.9rem;">${u.username}</span>
                        </div>
                        <span style="color:#10b981; font-weight:700; font-size:0.85rem;">‚Çπ ${u.balance.toLocaleString()}</span>
                    </div>
                `;
            });
        }

        function startShuffle() {
            if(shuffleInterval) clearInterval(shuffleInterval);
            shuffleInterval = setInterval(() => {
                if(document.hidden) return; // Optimization: Pause when tab hidden
                
                // Slower shuffle (30s)
                if(leaderboardData.length > 0) {
                    const randIdx = Math.floor(Math.random() * leaderboardData.length);
                    const boost = Math.floor(Math.random() * 2000) + 500;
                    leaderboardData[randIdx].balance += boost;
                    renderLeaderboard();
                }
            }, 30000); 
        }

        function renderActiveWork(projects) {
            const container = document.getElementById('projectListSection');
            container.innerHTML = "";
            const activeProjects = projects.filter(p => !p.is_finalized && p.status !== 'REJECTED');

            // UPDATE ACTIVE COUNT STAT
            const statCount = document.getElementById('statActiveCount');
            if(statCount) statCount.innerText = activeProjects.length;

            // HERO EMPTY STATE
            // HERO EMPTY STATE
            if(activeProjects.length === 0) {
                // container.style.display = "block"; // Removed, using innerHTML wrapper
                container.innerHTML = `
                    <div class="hero-empty">
                        <div class="hero-icon">üéâ</div>
                        <h2 class="hero-title">All Caught Up!</h2>
                        <p class="hero-sub">You have no pending assignments at the moment. Great job clearing your queue.</p>
                        
                        <div class="hero-stats">
                            <div class="stat-item">
                                <div class="stat-val">‚Çπ${userProfile.wallet ? userProfile.wallet.toLocaleString() : '0'}</div>
                                <div class="stat-label">Wallet Balance</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-val">${projects.filter(p => p.is_finalized).length}</div>
                                <div class="stat-label">Completed Batches</div>
                            </div>
                        </div>

                        <div style="display:flex; gap:15px;">
                            <button class="btn btn-outline" style="width:auto; margin:0;" onclick="loadData()">üîÑ Refresh Check</button>
                            <button class="btn btn-primary" style="width:auto; margin:0;" onclick="switchTab('profile', document.querySelectorAll('.tab-btn')[3])">Update Profile</button>
                        </div>
                    </div>
                `;
                return;
            }

            // GRID VIEW - Wrapped in inner div to maintain parent structure
            // container.style.display = "grid"; // REMOVED
            
            let gridHtml = `<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:20px;">`;
            
            activeProjects.forEach(p => {
                const percent = p.total_images > 0 ? Math.round((p.completed_by_user / p.total_images) * 100) : 0;
                const isDone = p.completed_by_user >= p.total_images && p.total_images > 0;
                
                // Status Mapping (Backend now returns proper status)
                let statusClass = 'status-active';
                if(p.status === 'COMPLETED') statusClass = 'status-success'; // Green
                if(p.status === 'UNDER REVIEW') statusClass = 'status-warn'; // Orange/Yellow
                if(p.status === 'REJECTED') statusClass = 'status-error'; // Red
                if(p.status === 'READY TO SUBMIT') statusClass = 'status-ready'; // Blue/Pulse
                
                // Timer Logic
                // Timer Logic: Show if Pending or Rejected
                let timerHtml = '';
                // Show timer if we have a deadline AND (Status is not final OR it is rejected so time matters)
                if(p.deadline && p.status !== 'COMPLETED' && p.status !== 'UNDER REVIEW') {
                     // REJECTED HANDLING
                     if(p.status === 'REJECTED') {
                        timerHtml = `
                        <div style="background:rgba(239,68,68,0.1); border:1px solid #ef4444; color:#ef4444; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.9rem;">
                            <strong>‚ö†Ô∏è REJECTED:</strong> ${p.admin_feedback || "Please review and fix."}
                        </div>`;
                     } else {
                         timerHtml = `<div class="project-timer" data-deadline="${p.deadline}" style="background:rgba(255,255,255,0.05); padding:6px 10px; border-radius:6px; margin-bottom:15px; font-family:monospace; display:flex; align-items:center; gap:8px;">
                            <span>‚è≥ Time Remaining:</span>
                            <span class="timer-display" style="color:var(--primary); font-weight:700;">--:--:--</span>
                        </div>`;
                     }
                }

                gridHtml += `
                    <div class="card">
                        <div class="card-top">
                            <div>
                                <div class="batch-title">Batch #${p.id.split('-')[1]}</div>
                                <div class="batch-sub">Priority Assignment</div>
                            </div>
                            <span class="status-badge ${statusClass}">${p.status}</span>
                        </div>
                        
                        ${timerHtml}
                        
                        <div class="progress-text"><span>Completion</span><span>${percent}%</span></div>
                        <div class="progress-track"><div class="progress-fill" style="width:${percent}%"></div></div>
                        <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom: 20px;">
                            ${p.completed_by_user} of ${p.total_images} records processed
                        </p>

                        ${isDone 
                            ? (p.status === 'COMPLETED' || p.status === 'UNDER REVIEW'
                                ? `<button class="btn" style="background:var(--surface); color:var(--text-muted); cursor:not-allowed;">${p.status}</button>`
                                : `<div style="display:flex; gap:10px;">
                                     <button class="btn btn-outline" style="margin-top:0;" onclick="startWork('${p.id}')">Review / Edit</button>
                                     <button class="btn btn-primary pulse-btn" style="margin-top:0; background:linear-gradient(135deg, #facc15, #eab308); color:#0f172a; font-weight:700; border:none;" onclick="submitBatch('${p.id}')">Submit for Review üöÄ</button>
                                   </div>`
                              )
                            : `<button class="btn btn-outline" onclick="startWork('${p.id}')">Continue Work &rarr;</button>`
                        }
                    </div>
                `;
            });
            gridHtml += `</div>`;
            container.innerHTML = gridHtml;
            
            startProjectTimers();
        }

        let timerInterval;
        function startProjectTimers() {
            if(timerInterval) clearInterval(timerInterval);
            
            const update = () => {
                if(document.hidden) return; // Optimization: Pause when tab hidden

                document.querySelectorAll('.project-timer').forEach(el => {
                    const deadline = new Date(el.getAttribute('data-deadline')).getTime();
                    const now = new Date().getTime();
                    const diff = deadline - now;
                    
                    const display = el.querySelector('.timer-display');
                    
                    if(diff <= 0) {
                        display.innerText = "Expired";
                        display.style.color = "#ef4444";
                    } else {
                        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        
                        if(days > 0) display.innerText = `${days}d ${hours}h ${minutes}m`;
                        else display.innerText = `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
                    }
                });
            };
            
            update(); // Initial run
            timerInterval = setInterval(update, 1000);
        }

        function renderHistory(projects) {
            const container = document.getElementById('tab-history');
            container.innerHTML = "";
            const history = projects.filter(p => p.is_finalized || p.status === 'REJECTED');
            
            if(history.length === 0) {
                container.innerHTML = `
                    <div style="grid-column:1/-1; text-align:center; padding:60px 20px; background:rgba(255,255,255,0.02); border-radius:16px; border:1px dashed rgba(255,255,255,0.1);">
                        <div style="font-size:3rem; margin-bottom:15px; opacity:0.5;">üìú</div>
                        <h3 style="margin:0 0 10px 0; color:white;">No Submission History</h3>
                        <p style="color:var(--text-muted); margin:0;">Your completed projects will appear here.</p>
                    </div>`;
                return;
            }

            history.forEach(p => {
                let badge = p.status === 'COMPLETED' ? 'status-approved' : (p.status === 'REJECTED' ? 'status-error' : 'status-review');
                let statusInfo = p.status;
                let borderColor = p.status === 'REJECTED' ? 'border-left: 4px solid #ef4444;' : (p.status === 'COMPLETED' ? 'border-left: 4px solid #10b981;' : '');

                container.innerHTML += `
                    <div class="card" style="${borderColor} margin-bottom:15px; transition: transform 0.2s;">
                        <div class="card-top">
                            <div>
                                <div class="batch-title">Batch #${p.id.split('-')[1]}</div>
                                <div class="batch-sub" style="font-size:0.85rem; color:var(--text-muted);">
                                    ${p.total_images} Records ‚Ä¢ ${p.status === 'REJECTED' ? 'Action Required' : 'Submitted'}
                                </div>
                            </div>
                            <span class="status-badge ${badge}">${statusInfo}</span>
                        </div>
                        
                        ${p.status === 'REJECTED' && p.admin_feedback ? `
                        <div style="background:rgba(239,68,68,0.1); color:#ef4444; padding:10px; border-radius:6px; margin-top:10px; font-size:0.9rem;">
                            <strong>Reason:</strong> ${p.admin_feedback}
                        </div>
                        ` : ''}
                        
                        ${p.status === 'COMPLETED' ? `
                            <div style="margin-top:15px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.05);">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div style="font-size:0.8rem; color:var(--text-muted);">Work: ‚Çπ${p.salary} x ${p.completed_by_user}</div>
                                    <div style="font-size:0.9rem; color:white;">‚Çπ${(p.salary * p.completed_by_user).toLocaleString()}</div>
                                </div>
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">
                                    <div style="font-size:0.8rem; color:var(--text-muted);">Security Refund:</div>
                                    <div style="font-size:0.9rem; color:white;">‚Çπ${(p.reward - (p.salary * p.completed_by_user)).toLocaleString()}</div>
                                </div>
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px; padding-top:8px; border-top:1px dashed rgba(255,255,255,0.1);">
                                    <div style="font-size:0.85rem; font-weight:700; color:#10b981;">TOTAL CREDITED</div>
                                    <div style="font-size:1rem; font-weight:700; color:#10b981;">+ ‚Çπ${(p.reward || 0).toLocaleString()}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
        }

        async function loadWithdrawals() {
            const res = await fetchSecure('/api/withdrawals/history');
            if(res && res.ok) {
                const data = await res.json();
                const list = document.getElementById('withdrawalList');
                if(data.length === 0) {
                    list.innerHTML = `
                        <div style="text-align:center; padding:60px 20px; background:rgba(255,255,255,0.02); border-radius:16px; border:1px dashed rgba(255,255,255,0.1);">
                            <div style="font-size:3rem; margin-bottom:15px; opacity:0.5;">üí∏</div>
                            <h3 style="margin:0 0 10px 0; color:white;">No Withdrawals Yet</h3>
                            <p style="color:var(--text-muted); margin:0;">Your withdrawal history will appear here.</p>
                        </div>`;
                    return;
                }
                list.innerHTML = data.map(w => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; background:rgba(255,255,255,0.03); border-radius:12px;">
                        <div>
                            <div style="font-weight:700; font-size:1.1rem;">‚Çπ${w.amount.toLocaleString()}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${new Date(w.requested_at).toLocaleDateString()}</div>
                        </div>
                        <div class="status-badge" style="background:${w.status==='APPROVED'?'rgba(52,211,153,0.2)':'rgba(255,255,255,0.1)'}; color:${w.status==='APPROVED'?'var(--success)':'var(--text-muted)'};">
                            ${w.status}
                        </div>
                    </div>
                `).join('');
            }
            }
        
        function updatePayoutEst() {
            const amtInput = document.getElementById('withdrawAmount');
            if(!amtInput) return;
            
            const amt = parseFloat(amtInput.value) || 0;
            const isInstant = document.getElementById('withdrawInstant').checked;
            const estDiv = document.getElementById('payoutEst');
            
            if(amt <= 0) {
                estDiv.style.display = 'none';
                return;
            }
            
            estDiv.style.display = 'flex';
            
            if(isInstant) {
                const fee = amt * 0.02; // 2%
                const final = amt - fee;
                document.getElementById('payoutFinalAmt').innerText = `‚Çπ${Math.floor(final).toLocaleString()} (Fee: ‚Çπ${Math.ceil(fee)})`;
            } else {
                document.getElementById('payoutFinalAmt').innerText = `‚Çπ${amt.toLocaleString()}`;
            }
        }
        
        function setMaxWithdrawal() {
             const max = userProfile.wallet || 0;
             document.getElementById('withdrawAmount').value = max;
             updatePayoutEst();
        }

        async function submitWithdrawal() {
            const amtInput = document.getElementById('withdrawAmount');
            const amt = parseFloat(amtInput.value);
            const isInstant = document.getElementById('withdrawInstant').checked;
            
            if(!amt || amt < 500) return showToast("Minimum withdrawal is ‚Çπ500");
            if(amt > (userProfile.wallet || 0)) return showToast("Insufficient balance");
            
            try {
                const res = await fetchSecure('/api/withdrawals/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        amount: amt, 
                        is_instant: isInstant,
                        method: isInstant ? 'IMPS' : 'NEFT'
                    })
                });
                
                if(res) {
                    const data = await res.json();
                    if(res.ok) {
                        showToast("Withdrawal Requested! üí∏");
                        document.getElementById('withdrawModal').style.display='none';
                        amtInput.value = '';
                        loadData(); // Refresh wallet
                        loadWalletHistory();
                    } else {
                        // Handle 422 Array or String
                        let msg = data.detail;
                        if(Array.isArray(msg)) {
                            msg = msg.map(e => e.msg).join(', ');
                        }
                        showToast(msg || "Request failed");
                    }
                }
            } catch(e) { console.error(e); showToast("Error connecting to server"); }
        }


        
        // --- SYSTEM CONFIG ---
        // --- SYSTEM CONFIG ---
        async function loadSystemConfig() {
            try {
                const res = await fetchSecure('/api/system/config');
                if(!res || !res.ok) return; // Silent fail
                
                const data = await res.json();
                
                // Update Brand
                const brandEl = document.querySelector('.brand');
                if(brandEl) brandEl.innerText = data.brand_name;
                document.title = `Employee | ${data.brand_name}`;
                
                // Update WhatsApp Link Logic
                const cleanerMobile = data.support_contact.replace(/\D/g,'');
                const waLink = `https://wa.me/${cleanerMobile}`;
                
                // Update all anchor tags with WhatsApp links
                document.querySelectorAll('a[href*="wa.me"]').forEach(btn => btn.href = waLink);
                
                // Update specifically the WhatsApp FAB (if it exists and doesn't use href)
                const waFabs = document.querySelectorAll('.whatsapp-btn');
                waFabs.forEach(btn => {
                    if(btn.tagName === 'A') btn.href = waLink;
                    else btn.onclick = () => window.open(waLink, '_blank');
                });

            } catch(e) { console.error("Config Error", e); }
        }

        // Custom Alert Logic
        function showCustomAlert(msg, title="Notice") {
            document.getElementById('alertMsg').innerText = msg;
            document.getElementById('alertTitle').innerText = title;
            const overlay = document.getElementById('customAlert');
            overlay.style.display = 'flex';
            setTimeout(() => document.getElementById('alertBox').classList.add('show'), 10);
        }
        function closeCustomAlert() {
            document.getElementById('alertBox').classList.remove('show');
            setTimeout(() => document.getElementById('customAlert').style.display = 'none', 200);
        }
        

        /* --- UI UTILS --- */
        function switchTab(id, btn) {
            document.querySelectorAll('.view').forEach(e => e.style.display='none');
            const target = document.getElementById('tab-'+id);

            // FIX: Unified Grid/Block behavior. 
            // If the section is designed as grid (like active), use grid. Else block.
            if(id === 'active' || id === 'history') target.style.display = 'grid';
            else target.style.display = 'block';
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            
            if(id === 'history') loadProjectHistory();
            if(id === 'withdrawals') loadWalletHistory(); // Fixed: Call finance loader
            if(id === 'active') loadData(); 
            if(id === 'analytics') loadAnalytics(); // Now implemented
            if(id === 'community') loadCommunityFeed();
        }

        async function loadProjectHistory() {
            const container = document.getElementById('tab-history');
            if(!container) return;
            
            container.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:var(--text-muted); padding:40px;">Loading history...</div>';
            
            try {
                if(typeof fetchSecure !== 'function') {
                    container.innerHTML = '<div style="color:red; text-align:center;">Error: Client misconfiguration (fetchSecure)</div>';
                    return;
                }

                // Fetch all projects
                const res = await fetchSecure('/api/projects/history'); 
                
                if(!res) {
                    throw new Error("Network Response Empty");
                }
                if(!res.ok) {
                    try {
                        const err = await res.json();
                        throw new Error(err.detail || "Server Error");
                    } catch(e) { throw new Error(`HTTP Error ${res.status}`); }
                }
                
                const projects = await res.json();
                console.log("History loaded:", projects);
                
                // Debug Header (Temporary)
                let debugHtml = `<div style="grid-column:1/-1; color:gray; font-size:0.8rem; margin-bottom:10px;">Debug: Loaded ${projects.length} items</div>`;
                
                if(!projects || projects.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column:1/-1; text-align:center; padding:60px; background:rgba(255,255,255,0.02); border-radius:20px; border:1px dashed rgba(255,255,255,0.1);">
                            <div style="font-size:3rem; opacity:0.3; margin-bottom:15px;">üìÇ</div>
                            <h3 style="color:var(--text-muted); margin-bottom:5px;">No History Yet</h3>
                            <p style="color:var(--text-muted); opacity:0.7;">Completed projects will appear here.</p>
                        </div>
                    `;
                    return;
                }
                
                const htmlString = projects.map((p, i) => {
                    let statusColor = 'var(--text-muted)';
                    let statusText = p.status || 'UNKNOWN';
                    
                    if (p.status === 'REJECTED') { statusColor = 'var(--danger)'; statusText = 'REJECTED'; }
                    else if(p.is_approved) { statusColor = 'var(--success)'; statusText = 'APPROVED'; }
                    else if(p.is_finalized) { statusColor = '#facc15'; statusText = 'UNDER REVIEW'; }
                    
                    // Format Date
                    const date = p.completed_at ? new Date(p.completed_at).toLocaleDateString() : 'In Progress';
                    const batchId = (p.id && p.id.includes('-')) ? p.id.split('-')[1] : (p.id || '???');

                    // Force background color for visibility check
                    return `
                    <div class="card" style="padding:20px; background:#1e293b; border:1px solid rgba(255,255,255,0.1); border-radius:12px; margin-bottom:0;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:15px;">
                            <div>
                                <div style="font-family:monospace; color:var(--text-muted); font-size:0.8rem; margin-bottom:5px;">BATCH-${batchId}</div>
                                <h3 style="margin:0; font-size:1.1rem; color:white;">Image Batch</h3>
                            </div>
                            <div class="status-badge" style="background:${statusColor}20; color:${statusColor}; border:1px solid ${statusColor}40;">
                                ${statusText}
                            </div>
                        </div>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:0.9rem; color:var(--text-muted); margin-bottom:15px;">
                            <div>Images: <span style="color:white;">${p.image_count || 0}</span></div>
                            <div>Earned: <span style="color:${p.is_approved ? 'var(--success)' : 'white'};">‚Çπ${p.payout_amount || 0}</span></div>
                            <div style="grid-column:1/-1;">Data: <span style="color:white;">${date}</span></div>
                        </div>
                        
                        ${p.admin_feedback ? `
                        <div style="background:rgba(239, 68, 68, 0.1); border:1px solid rgba(239, 68, 68, 0.2); padding:10px; border-radius:8px; font-size:0.85rem; color:#fca5a5;">
                            <strong>Feedback:</strong> ${p.admin_feedback}
                        </div>` : ''}
                    </div>
                    `;
                }).join('');

                console.log("Generated HTML length:", htmlString.length);
                
                // Clean Grid Restore
                container.innerHTML = htmlString;
 
                
            } catch(e) {
                console.error("History Load Error", e);
                container.innerHTML = `
                    <div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--danger); background:rgba(239,68,68,0.05); border-radius:12px;">
                        <h3>Failed to load history</h3>
                        <p>${e.message}</p>
                        <button onclick="loadProjectHistory()" style="background:var(--danger); color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer; margin-top:10px;">Retry</button>
                    </div>`;
                if(typeof showToast === 'function') showToast("Error loading history: " + e.message);
            }
        }

        function toggleEdit(on) {
            document.querySelectorAll('#profileForm input').forEach(i => i.disabled = !on);
            document.getElementById('editBtn').style.display = on ? 'none' : 'block';
            document.getElementById('saveActions').style.display = on ? 'block' : 'none';
        }

        function openWithdrawModal() {
            if(!userProfile.bank_account_number || userProfile.bank_account_number.length < 5) {
                alert("‚ö†Ô∏è Please add your bank details in the 'My Profile' tab first.");
                switchTab('profile', document.querySelectorAll('.tab-btn')[4]);
                toggleEdit(true); 
                return;
            }
            
            // Set Balance
            const bal = userProfile.wallet || 0;
            const balEl = document.getElementById('modalWalletBal');
            if(balEl) balEl.innerText = '‚Çπ' + bal.toLocaleString();
            
            // Reset Form - Ensure elements exist
            const amtInput = document.getElementById('withdrawAmount');
            if(amtInput) amtInput.value = '';
            
            const instantCheck = document.getElementById('withdrawInstant');
            if(instantCheck) instantCheck.checked = false;
            
            if(typeof updatePayoutEst === 'function') updatePayoutEst();
            
            document.getElementById('withdrawModal').style.display = 'flex';
        }

        function copyReferral() {
            if(window.currentUserRefCode) {
                navigator.clipboard.writeText(window.currentUserRefCode).then(() => {
                   showToast("Referral Code Copied! üìã");
                });
            }
        }

        // Optimized Polling (30s)
        let pollInterval;
        function startPolling() {
            if(pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(loadData, 30000);
        }
        function stopPolling() {
             if(pollInterval) clearInterval(pollInterval);
        }
        


        // --- WALLET LOGIC ---
        function toggleWalletDropdown() {
            const dd = document.getElementById('walletDropdown');
            if(dd.style.display === 'block') {
                dd.style.display = 'none';
            } else {
                dd.style.display = 'block';
                loadWalletHistorySmall();
            }
        }
        
        // Load small history for dropdown
        async function loadWalletHistorySmall() {
            const list = document.getElementById('walletDropdownList');
            list.innerHTML = '<div style="padding:10px; text-align:center; color:var(--text-muted);">Loading...</div>';
            
            try {
                const res = await fetchSecure('/api/wallet/history');
                if(res && res.ok) {
                    const txs = await res.json();
                    if(txs.length === 0) {
                        list.innerHTML = '<div style="padding:10px; text-align:center; color:var(--text-muted);">No recent activity</div>';
                        return;
                    }
                    // Show last 5
                    list.innerHTML = txs.slice(0,5).map(t => {
                         const isCredit = t.amount >= 0;
                         return `
                            <div style="padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.85rem; display:flex; justify-content:space-between;">
                                <div>
                                    <div style="color:white;">${t.description || t.type}</div>
                                    <div style="font-size:0.75rem; color:var(--text-muted);">${new Date(t.timestamp).toLocaleDateString()}</div>
                                </div>
                                <div style="font-weight:600; color:${isCredit?'#10b981':'#ef4444'};">
                                    ${isCredit?'+':''}‚Çπ${Math.abs(t.amount)}
                                </div>
                            </div>
                         `;
                    }).join('');
                }
            } catch(e) { console.error(e); }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dd = document.getElementById('walletDropdown');
            const btn = document.getElementById('walletDisplay');
            if(dd.style.display === 'block' && !dd.contains(e.target) && !btn.contains(e.target)) {
                dd.style.display = 'none';
            }
        });
        

        async function loadWalletHistory() {
            const list = document.getElementById('withdrawalList'); 
            if(!list) return;
            if(list.childElementCount === 0) list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">Loading...</div>';
            
            const res = await fetchSecure('/api/wallet/history');
            if(res && res.ok) {
                const txs = await res.json();
                if(txs.length === 0) {
                     list.innerHTML = `
                     <div style="text-align:center; padding:40px 20px;">
                        <div style="font-size:2rem; margin-bottom:10px; opacity:0.5;">üí≥</div>
                        <p style="color:var(--text-muted); margin:0;">No wallet transactions yet.</p>
                     </div>`;
                     return;
                }
                
                list.innerHTML = txs.map(t => {
                    const isCredit = t.amount >= 0;
                    const color = isCredit ? '#10b981' : '#ef4444';
                    const sign = isCredit ? '+' : '';
                    
                    return `
                    <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.03); padding:15px; border-radius:10px; border-left:4px solid ${color};">
                        <div>
                            <div style="font-weight:600; font-size:0.95rem; margin-bottom:2px;">${t.description || t.type}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${new Date(t.timestamp).toLocaleString()}</div>
                        </div>
                        <div style="font-weight:700; color:${color}; font-size:1rem;">
                            ${sign}‚Çπ${Math.abs(t.amount).toLocaleString()}
                        </div>
                    </div>
                    `;
                }).join('');
            } else {
                 list.innerHTML = '<div style="text-align:center; color:#ef4444;">Failed to load history</div>';
            }
        }

        document.addEventListener("visibilitychange", () => {
            if (document.hidden) stopPolling();
            else { loadData(); startPolling(); }
        });
        startPolling();
        loadData();
        loadSystemConfig();
    </script>
    <script>


        // --- ANNOUNCEMENTS ---
        async function checkAnnouncements() {
            try {
                const res = await fetchSecure('/api/public/announcement');
                if(!res || !res.ok) return;
                const data = await res.json();
                if(data && data.title) {
                    const lastSeen = localStorage.getItem('last_ann_id');
                    if(String(lastSeen) !== String(data.id)) {
                        document.getElementById('annModalTitle').innerText = data.title;
                        document.getElementById('annModalContent').innerText = data.content;
                        document.getElementById('announcementModal').style.display = 'flex';
                        window.currentAnnId = data.id;
                    }
                }
            } catch(e) { console.error("Announce Check Fail", e); }
        }

        function closeAnnouncement() {
            document.getElementById('announcementModal').style.display = 'none';
            if(window.currentAnnId) localStorage.setItem('last_ann_id', window.currentAnnId);
        }

        // Init
        checkAnnouncements();
        loadChallenges();
        // Load Community if active tab is community? Or just load it lazy.
        // For now I'll load it once. 
        // Better: loadCommunityFeed();
        
        // --- COMMUNITY LOGIC ---
        async function loadCommunityFeed() {
            const feed = document.getElementById('postFeed');
            try {
                const res = await fetchSecure('/api/community/posts');
                if(!res.ok) return;
                const posts = await res.json();
                
                renderCommunityFeed(posts);
                
            } catch(e) { console.error("Feed Error", e); }
        }
        
        async function createPost() {
            const textarea = document.getElementById('postContent');
            const btn = document.getElementById('postBtn');
            const content = textarea.value.trim();
            
            // Validation
            if(!content || content.length < 5) {
                showToast("Post must be at least 5 characters");
                return;
            }
            if(content.length > 500) {
                showToast("Post cannot exceed 500 characters");
                return;
            }
            
            // Disable button during submission
            btn.disabled = true;
            btn.innerHTML = '<span style="display:flex; align-items:center; gap:8px;">‚è≥ Posting...</span>';

            try {
                const res = await fetchSecure('/api/community/posts', {
                    method: 'POST',
                    body: JSON.stringify({ content: content })
                });
                if(res && res.ok) {
                    textarea.value = "";
                    document.getElementById('postCharCount').innerText = '0/500';
                    showToast("Post submitted for review! ‚è≥"); 
                    
                    const feed = document.getElementById('postFeed');
                    if(feed) {
                        const existingAlert = document.getElementById('pendingAlert');
                        if(existingAlert) existingAlert.remove();
                        
                        const alert = document.createElement('div');
                        alert.id = 'pendingAlert';
                        alert.innerHTML = `
                            <div style="background:rgba(234,179,8,0.1); color:#facc15; padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid rgba(234,179,8,0.3); display:flex; align-items:center; gap:10px;">
                                <span style="font-size:1.2rem;">üìù</span>
                                <div>
                                    <div style="font-weight:700;">Sent for Moderation</div>
                                    <div style="font-size:0.85rem; opacity:0.8;">Your post will be visible once approved by Admin.</div>
                                </div>
                            </div>`;
                        feed.prepend(alert);
                    }
                } else {
                    showToast("Failed to post");
                }
            } catch(e) { 
                console.error(e); 
                showToast("Error submitting post");
            } finally {
                btn.disabled = true; // Keep disabled after submit until they type again
                btn.innerHTML = '<span style="display:flex; align-items:center; gap:8px;">‚ú® Post Update</span>';
            }
        }
        
        // Add input validation listener for postContent
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('postContent');
            const charCount = document.getElementById('postCharCount');
            const btn = document.getElementById('postBtn');
            
            if(textarea && charCount && btn) {
                textarea.addEventListener('input', function() {
                    const len = this.value.trim().length;
                    charCount.innerText = `${len}/500`;
                    
                    // Color coding
                    if(len > 450) charCount.style.color = '#ef4444';
                    else if(len > 350) charCount.style.color = '#facc15';
                    else charCount.style.color = 'var(--text-muted)';
                    
                    // Enable/disable button
                    btn.disabled = (len < 5 || len > 500);
                });
            }
        });


function renderCommunityFeed(posts) {
    const feed = document.getElementById('postFeed');
    if(!feed) return; 

    if(!posts || posts.length === 0) {
         feed.innerHTML = `
            <div class="hero-empty" style="padding:60px 20px; text-align:center;">
                <div style="font-size:3rem; margin-bottom:15px; filter:grayscale(1); opacity:0.5;">üí¨</div>
                <h3 style="color:var(--text-muted); font-weight:500;">No active discussions</h3>
                <p style="color:var(--text-muted); font-size:0.9rem;">Start a conversation with your team!</p>
            </div>`;
         return;
    }

            feed.innerHTML = posts.map(p => {
                // Status Badge Logic
                let badge = '';
                let opacity = '1';
                let feedbackHtml = '';
                
                if(p.is_mine) {
                    if(p.status === 'REJECTED') {
                        badge = `<span style="background:rgba(239,68,68,0.1); color:#ef4444; border:1px solid rgba(239,68,68,0.3); padding:2px 8px; border-radius:12px; font-size:0.7rem; font-weight:600; display:inline-flex; align-items:center; gap:4px;">REJECTED</span>`;
                        feedbackHtml = `<div style="background:rgba(239,68,68,0.1); color:#ef4444; padding:12px; border-radius:8px; margin-top:12px; font-size:0.9rem; border-left:3px solid #ef4444;">
                            <div style="font-weight:700; margin-bottom:4px;">Admin Feedback</div>
                            ${p.admin_feedback || "Content violation."}
                        </div>`;
                    } else if (p.status === 'PENDING' || !p.is_approved) {
                        badge = `<span style="background:rgba(234,179,8,0.1); color:#facc15; border:1px solid rgba(234,179,8,0.3); padding:2px 8px; border-radius:12px; font-size:0.7rem; font-weight:600; display:inline-flex; align-items:center; gap:4px;">PENDING</span>`;
                        opacity = '0.85';
                    }
                }

                // Avatar Logic - Consistent Colors based on name
                let avatarSrc = p.author_pic;
                const authorName = p.author_name || 'User';

                if(!avatarSrc || avatarSrc.includes('default') || !avatarSrc.includes('/') || avatarSrc.includes('{')) {
                    // Simple hash for consistent color
                    let hash = 0;
                    for (let i = 0; i < authorName.length; i++) { hash = authorName.charCodeAt(i) + ((hash << 5) - hash); }
                    const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
                    const bg = "00000".substring(0, 6 - c.length) + c;
                    avatarSrc = `https://ui-avatars.com/api/?name=${encodeURIComponent(authorName)}&background=${bg}&color=fff&size=64&font-size=0.4`;
                }
                
                // Relative Time
                const date = new Date(p.created_at);
                const now = new Date();
                const diff = (now - date) / 1000; // seconds
                let timeStr = date.toLocaleDateString();
                if(diff < 60) timeStr = 'Just now';
                else if(diff < 3600) timeStr = `${Math.floor(diff/60)}m ago`;
                else if(diff < 86400) timeStr = `${Math.floor(diff/3600)}h ago`;
                else if(diff < 604800) timeStr = `${Math.floor(diff/86400)}d ago`;

                return `
                <div class="card" style="margin-bottom:20px; padding:0; overflow:hidden; opacity:${opacity}; border:1px solid rgba(255,255,255,0.08); background:#1e293b; border-radius:16px;">
                    <div style="padding:20px 20px 0 20px;">
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <div style="display:flex; gap:12px;">
                                <img src="${avatarSrc}" style="width:48px; height:48px; border-radius:50%; object-fit:cover; border:2px solid rgba(255,255,255,0.05);">
                                <div>
                                    <div style="font-weight:600; color:white; font-size:1rem; display:flex; align-items:center; gap:8px;">
                                        ${authorName}
                                        ${badge}
                                    </div>
                                    <div style="color:var(--text-muted); font-size:0.8rem; margin-top:2px;">${timeStr}</div>
                                </div>
                            </div>
                            ${p.is_mine ? '<div style="color:var(--text-muted); cursor:pointer; font-size:1.2rem; padding:0 5px;" title="Options">...</div>' : ''}
                        </div>
                        
                        <div style="color:#f1f5f9; font-size:1rem; line-height:1.6; margin-top:16px; margin-bottom:16px; white-space:pre-wrap;">${p.content || ''}</div>
                        ${feedbackHtml}
                    </div>
                    
                    <div style="background:rgba(0,0,0,0.2); padding:12px 20px; display:flex; gap:20px; border-top:1px solid rgba(255,255,255,0.05);">
                        <button class="btn" onclick="likePost('${p.id}')" style="background:transparent; color:${p.is_liked ? '#f43f5e' : 'var(--text-muted)'}; padding:5px 8px; display:flex; align-items:center; gap:8px; font-size:0.9rem; transition:0.2s;">
                            <span style="font-size:1.1rem;">${p.is_liked ? '‚ù§Ô∏è' : 'ü§ç'}</span> 
                            <span>${p.likes_count || 0} Likes</span>
                        </button>
                    </div>
                    </div>
                </div>
            `}).join('');
        }
        
        async function likePost(pid) {
           try {
                const res = await fetchSecure(`/api/community/posts/${pid}/like`, { method: 'POST' });
                if(res.ok) loadCommunityFeed(); // Refresh to show correct count/status
           } catch(e) { console.error(e); }
        }

        // --- CHALLENGE LOGIC ---
        async function loadChallenges() {
            try {
                const res = await fetchSecure('/api/challenges/active');
                if(!res || !res.ok) return;
                const challenges = await res.json();
                
                const container = document.getElementById('challengeContainer');
                container.innerHTML = '';
                
                if(challenges.length === 0) return; // Hide if none?
                
                challenges.forEach(ch => {
                    const pct = Math.min((ch.progress / ch.target_count) * 100, 100);
                    const isDone = ch.progress >= ch.target_count;
                    
                    let actionBtn = '';
                    if(ch.is_claimed) {
                        actionBtn = `<button disabled class="btn btn-outline" style="width:100%; border-color:#10b981; color:#10b981;">‚úÖ Claimed</button>`;
                    } else if(isDone) {
                        actionBtn = `<button class="btn btn-primary ripple-btn shake-animation" style="width:100%; background:#facc15; color:black; font-weight:700;" onclick="claimReward('${ch.id}')">üéÅ Claim ‚Çπ${ch.reward_amount}</button>`;
                    } else {
                        actionBtn = `<div style="text-align:center; font-size:0.8rem; color:var(--text-muted);">${ch.progress} / ${ch.target_count} Tasks</div>`;
                    }
                    
                    const el = document.createElement('div');
                    el.className = 'card';
                    el.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(16, 185, 129, 0.05))';
                    el.style.border = '1px solid rgba(245, 158, 11, 0.3)';
                    el.innerHTML = `
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <h3 style="margin:0; font-size:1rem; color:#facc15;">‚ö° ${ch.title}</h3>
                            <span style="font-weight:700; color:#10b981;">+‚Çπ${ch.reward_amount}</span>
                        </div>
                        <p style="margin:0 0 10px 0; font-size:0.85rem; color:#e2e8f0;">${ch.description}</p>
                        
                        <div class="progress-bar" style="margin-bottom:10px;">
                            <div class="progress-fill" style="width:${pct}%; background:#facc15;"></div>
                        </div>
                        
                        ${actionBtn}
                    `;
                    container.appendChild(el);
                });
                
            } catch(e) { console.error("Challenge Error", e); }
        }
        
        async function claimReward(cid) {
            try {
                const res = await fetchSecure(`/api/challenges/${cid}/claim`, { method: 'POST' });
                const data = await res.json();
                if(res.ok) {
                    showToast(data.message);
                    // Update Balance
                    if(tabId === 'history') loadHistory();
                    if(tabId === 'active') loadData(); // Refresh active work
                    if(tabId === 'analytics') loadAnalytics();
                    if(tabId === 'community') loadCommunityFeed();
                    loadChallenges(); // Refresh state
                    loadChallenges(); // Refresh state
                    if(typeof confetti === 'function') {
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    } else {
                        triggerConfetti(); // Fallback to CSS version
                    }
                    // Fallback animation
                } else {
                    showToast("‚ùå " + data.detail);
                }
            } catch(e) { showToast("Error claiming reward"); }
        }

        // --- ANALYTICS LOGIC ---
        let earningsChart = null;
        let qualityChart = null;

        async function loadAnalytics() {
            // Show Loading?
            document.getElementById('anaSpeedText').innerText = "Loading...";

            if (typeof Chart === 'undefined') {
                 console.warn("Chart.js blocked or failed to load");
                 // We continue execution to at least show the numbers.
            }
            
            try {
                // Correct Endpoint: /api/analytics/personal
                const res = await fetchSecure('/api/analytics/personal');
                if(!res || !res.ok) {
                    document.getElementById('anaSpeedText').innerText = "Error loading data";
                    return;
                }
                const data = await res.json();
                
                // Metrics
                const earnings = data.total_earnings_30d || 0;
                document.getElementById('anaEarnings').innerText = `‚Çπ${earnings.toLocaleString()}`;
                document.getElementById('anaQuality').innerText = (data.avg_quality_30d || 0).toFixed(1);
                document.getElementById('anaSpeed').innerText = `${data.speed_percentile || 0}%`;
                document.getElementById('anaSpeedText').innerText = data.top_performer_text || "Calculating...";
                
                // Charts
                if (typeof Chart !== 'undefined') {
                    if (data.daily_earnings) renderEarningsChart(data.daily_earnings);
                    if (data.quality_trend) renderQualityChart(data.quality_trend);
                } else {
                    document.getElementById('anaSpeedText').innerText = "Charts unavailable (Offline)";
                }
                
            } catch(e) { console.error("Analytics Error", e); }
        }

        function renderEarningsChart(dataPoints) {
            const ctx = document.getElementById('chartEarnings').getContext('2d');
            if(earningsChart) earningsChart.destroy();
            
            earningsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataPoints.map(d => d.date.slice(5)), // MM-DD
                    datasets: [{
                        label: 'Earnings (‚Çπ)',
                        data: dataPoints.map(d => d.amount),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }
        
        function renderQualityChart(dataPoints) {
            const ctx = document.getElementById('chartQuality').getContext('2d');
            if(qualityChart) qualityChart.destroy();
            
            qualityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dataPoints.map(d => d.date.slice(5)),
                    datasets: [{
                        label: 'Quality Score',
                        data: dataPoints.map(d => d.score),
                        backgroundColor: '#facc15',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } },
                        y: { 
                            grid: { color: '#334155' }, 
                            ticks: { color: '#94a3b8' },
                            min: 0, max: 100 
                        }
                    }
                }
            });
        }

        function renderKYC(user) {
            const status = user.kyc_status || "NOT_UPLOADED";
            const badge = document.getElementById('kycStatusBadge');
            const uploadSec = document.getElementById('kycUploadSection');
            const rejectMsg = document.getElementById('kycRejectionMsg');
            const banner = document.getElementById('kycBanner');
            
            // Badge Logic
            badge.innerText = status.replace('_', ' ');
            badge.className = 'status-badge';
            
            if(status === 'APPROVED') {
                badge.classList.add('status-success');
                badge.innerHTML = "‚úÖ VERIFIED";
                uploadSec.style.display = 'none';
                rejectMsg.style.display = 'none';
                if(banner) banner.style.display = 'none';
            } 
            else if(status === 'PENDING') {
                badge.classList.add('status-review'); // Yellow
                uploadSec.style.display = 'none'; // Lock upload while pending? Yes.
                uploadSec.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-muted);">‚è≥ Documents under review by Admin. Verification takes 24-48 hours.</div>`;
                uploadSec.style.display = 'block';
                rejectMsg.style.display = 'none';
                if(banner) banner.style.display = 'none'; // Don't annoy if pending
            }
            else if(status === 'REJECTED') {
                badge.classList.add('status-error');
                uploadSec.style.display = 'block';
                rejectMsg.style.display = 'block';
                document.getElementById('kycRejectReason').innerText = user.kyc_rejection_reason || "Details mismatch";
                if(banner) banner.style.display = 'flex';
            }
            else { // NOT_UPLOADED
                badge.style.background = 'rgba(255,255,255,0.1)';
                uploadSec.style.display = 'block';
                rejectMsg.style.display = 'none';
                if(banner) banner.style.display = 'flex';
            }
        }

        async function submitKYC() {
             const aadhar = document.getElementById('kycAadhar').files[0];
             const pan = document.getElementById('kycPan').files[0];
             
             if(!aadhar || !pan) return showToast("‚ö†Ô∏è Both Aadhar and PAN cards are required.");
             
             const fd = new FormData();
             fd.append('aadhar', aadhar);
             fd.append('pan', pan);
             
             try {
                 const res = await fetchSecure('/api/profile/kyc-upload', {
                     method: 'POST',
                     body: fd
                 });
                 if(res && res.ok) {
                     showToast("KYC Documents Submitted! üîí");
                     // Optimistic Update
                     userProfile.kyc_status = "PENDING";
                     renderKYC(userProfile);
                     // Reload to be sure
                     setTimeout(loadData, 2000);
                 } else {
                     showToast("Upload failed");
                 }
             } catch(e) { console.error(e); showToast("Error uploading documents"); }
        }

    </script>
    <!-- Announcement Modal -->
    <div id="announcementModal" class="modal-overlay" style="z-index:9999;">
        <div class="modal" style="width:500px; text-align:center;">
            <div style="font-size:3rem; margin-bottom:10px;">üì¢</div>
            <h2 id="annModalTitle" style="color:var(--primary); margin-top:0;">Announcement</h2>
            <p id="annModalContent" style="color:#e2e8f0; font-size:1rem; line-height:1.6; white-space:pre-wrap; margin:20px 0;"></p>
            <button class="btn btn-primary" style="width:100%;" onclick="closeAnnouncement()">Got it</button>
        </div>
    </div>
    <!-- Certification Modal -->
    <div id="certModal" class="modal-overlay" style="display:none; z-index:9999;">
        <div class="modal" style="width: 600px; max-width:90%;">
            <h2 id="certTitle" style="color:var(--primary); margin-top:0;">Certification Test</h2>
            <div id="certBody" style="text-align:left; color:#e2e8f0; margin: 20px 0;">
                <!-- Content dynamically loaded -->
            </div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn" style="flex:1; background:transparent; border:1px solid var(--border); color:var(--text-muted);" onclick="document.getElementById('certModal').style.display='none'">Cancel</button>
                <button class="btn btn-primary" style="flex:1;" onclick="submitCertTest()">Submit Test</button>
            </div>
        </div>
    </div>

    <script>
        // Certification Logic
        let currentCertType = '';
        const certQuestions = {
            "medical_coding": [
                { q: "What does ICD stand for?", options: ["International Classification of Diseases", "Internal Code for Doctors", "Integrated Care Delivery"], a: 0 },
                { q: "Which code starts with 'E'?", options: ["Endocrine", "External Causes", "Eye Disorders"], a: 1 },
                { q: "CPT codes are maintained by?", options: ["WHO", "AMA", "CMS"], a: 1 },
                { q: "What is a 'modifier'?", options: ["A price change", "A code extension to give more detail", "A deleted code"], a: 1 },
                { q: "HIPAA primarily protects?", options: ["Doctors", "Patient Privacy", "Insurance Companies"], a: 1 }
            ],
            "typing_test": {
                text: "The rapid development of medical technology has significantly improved patient outcomes in recent years. Accurate documentation is crucial for healthcare continuity."
            }
        };

        window.startCertTest = function(type) {
            currentCertType = type;
            const modal = document.getElementById('certModal');
            const body = document.getElementById('certBody');
            const title = document.getElementById('certTitle');
            
            modal.style.display = 'flex';
            
            if (type === 'medical_coding') {
                title.innerText = "Medical Coding Assessment";
                let html = '<p>Answer the following questions:</p><form id="certForm">';
                certQuestions.medical_coding.forEach((q, i) => {
                    html += `<div style="margin-bottom:15px;">
                        <p style="margin-bottom:5px; font-weight:600;">${i+1}. ${q.q}</p>
                        ${q.options.map((opt, oi) => `
                            <label style="display:block; cursor:pointer; color:#94a3b8;">
                                <input type="radio" name="q${i}" value="${oi}"> ${opt}
                            </label>
                        `).join('')}
                    </div>`;
                });
                html += '</form>';
                body.innerHTML = html;
            } else if (type === 'typing_test') {
                title.innerText = "Typing Speed Test";
                const targetText = certQuestions.typing_test.text;
                body.innerHTML = `
                    <p>Type the text exactly as shown below:</p>
                    <div style="background:#1e293b; padding:10px; border-radius:6px; margin-bottom:10px; font-family:monospace;">${targetText}</div>
                    <textarea id="typingInput" rows="4" style="width:100%; background:#0f172a; border:1px solid var(--border); color:white; padding:10px; border-radius:6px;" placeholder="Start typing..."></textarea>
                `;
            }
        };

        window.submitCertTest = async function() {
             let score = 0;
             let passed = false;
             
             if (currentCertType === 'medical_coding') {
                 const form = document.getElementById('certForm');
                 const data = new FormData(form);
                 let correct = 0;
                 certQuestions.medical_coding.forEach((q, i) => {
                     if (parseInt(data.get(`q${i}`)) === q.a) correct++;
                 });
                 // 3/5 to pass (60%) - making it easier for demo
                 score = (correct / 5) * 100;
                 if (score >= 60) passed = true;
             } else if (currentCertType === 'typing_test') {
                 const input = document.getElementById('typingInput').value.trim();
                 const target = certQuestions.typing_test.text;
                 const accuracy = calculateAccuracy(input, target);
                 score = accuracy;
                 if (score > 90) passed = true; // Strict for typing
             }
             
             if (passed) {
                 // Call API
                 try {
                     const res = await fetchSecure('/api/certifications/complete', {
                         method: 'POST',
                         body: JSON.stringify({ cert_id: currentCertType, score: Math.round(score) })
                     });
                     if (res.ok) {
                         const d = await res.json();
                         if (d.status === 'passed') {
                             triggerConfetti();
                             showToast("Certification Passed! üèÜ");
                             setTimeout(() => { document.getElementById('certModal').style.display='none'; loadData(); }, 2000);
                             return;
                         }
                     }
                     showCustomAlert("You passed the local check but server failed.");
                 } catch(e) { console.error(e); showCustomAlert("Submission Error"); }
             } else {
                 showCustomAlert(`Test Failed. Score: ${Math.round(score)}%. Try again!`);
             }
        };

        function calculateAccuracy(input, target) {
            let hits = 0;
            const len = Math.min(input.length, target.length);
            for(let i=0; i<len; i++) {
                if(input[i] === target[i]) hits++;
            }
            return (hits / target.length) * 100;
            return (hits / target.length) * 100;
        }

        async function updateProfile(e) {
            e.preventDefault();
            const form = document.getElementById('profileForm');
            const data = {};
            
            // Extract all inputs
            Array.from(form.elements).forEach(el => {
                if(el.name && !el.disabled) {
                    data[el.name] = el.value;
                }
            });
            
            try {
                const res = await fetchSecure('/api/employees/me/update', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                if(res && res.ok) {
                    showToast("Profile Updated Successfully! üíæ");
                    toggleEdit(false);
                    // Update global userProfile object
                    Object.assign(userProfile, data);
                } else {
                    showToast("Update Failed");
                }
            } catch(err) { console.error(err); showToast("Server Error"); }
        }

        async function uploadPic() {
            const input = document.getElementById('picInput');
            if(!input.files || !input.files[0]) return;
            
            const fd = new FormData();
            fd.append('file', input.files[0]);
            
            try {
                const res = await fetchSecure('/api/profile/upload-pic', {
                    method: 'POST',
                    body: fd
                });
                
                if(res && res.ok) {
                    const data = await res.json();
                    document.getElementById('userAvatar').src = data.url;
                    // Also update header
                    const uAvatar = document.querySelector('.nav-user img'); // Assuming nav avatar structure
                    if(uAvatar) uAvatar.src = data.url;
                    
                    showToast("Profile Picture Updated! üì∏");
                } else {
                    showToast("Upload Failed");
                }
            } catch(e) { console.error(e); showToast("Upload Error"); }
        }

    </script>

        <!-- NEW: Active Work Interface -->
        <section id="tab-active-work" class="view slide-in" style="display:none; width:100%; max-width:1000px; margin:0 auto;">
            <div class="card" style="padding:0; overflow:hidden;">
                <div style="padding:20px; background:rgba(255,255,255,0.03); border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h3 style="margin:0; color:white;">Active Work Session</h3>
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-top:2px;">BATCH: <span id="work-batch-id">Loading...</span></div>
                    </div>
                    <button class="btn btn-outline" onclick="loadData(); switchTab('active');">Exit Session</button>
                </div>
                
                <div style="padding:30px; text-align:center;">
                    <div id="work-container-inner" style="min-height:400px; display:flex; align-items:center; justify-content:center; flex-direction:column;">
                        <!-- Content Injected via JS -->
                        <div class="loader"></div>
                    </div>
                </div>
            </div>
        </section>

    <script>
        // --- WORK INTERFACE VARIABLES ---
        let currentProjectWorkId = null;
        let currentImageWorkId = null;

        async function loadWorkInterface(projectId) {
            currentProjectWorkId = projectId;
            switchTab('active-work');
            document.getElementById('work-batch-id').innerText = projectId;
            const container = document.getElementById('work-container-inner');
            container.innerHTML = '<div class="loader"></div>';
            
            try {
                const res = await fetchSecure('/work/allocate', {
                    method: 'POST', 
                    body: JSON.stringify({ project_id: projectId, employee_id: userId })
                });
                
                if(res.ok) {
                    const data = await res.json();
                    if(data.status === 'COMPLETED') {
                        container.innerHTML = `
                            <div style="font-size:3rem; margin-bottom:20px;">üéâ</div>
                            <h3 style="color:white;">Batch Completed!</h3>
                            <p style="color:var(--text-muted);">All images processed.</p>
                            <button class="btn btn-primary" onclick="submitBatch('${projectId}')">Submit Batch for Review</button>
                        `;
                    } else if(data.images && data.images.length > 0) {
                        const img = data.images[0];
                        currentImageWorkId = img.id;
                        
                        // Check for review mode
                        const isReview = data.is_review || false;
                        let existingData = {};
                        if(isReview) {
                            // Fetch existing data
                            const subRes = await fetchSecure(`/work/get_submission/${userId}/${img.id}`);
                            if(subRes.ok) {
                                const sub = await subRes.json();
                                existingData = sub.data || {};
                            }
                        }

                        container.innerHTML = `
                            <div style="position:relative; max-width:100%; margin-bottom:20px;">
                                <img src="/${img.url}" style="max-width:100%; border-radius:8px; border:1px solid rgba(255,255,255,0.1);">
                                <div style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.7); padding:5px 10px; border-radius:20px; font-size:0.8rem;">
                                    Sequence: ${img.sequence}
                                </div>
                            </div>
                            
                            <div style="max-width:500px; width:100%; display:flex; gap:10px;">
                                <input type="text" id="work-input-label" class="input-modern" placeholder="Enter Label / Text..." value="${existingData.label || ''}" style="flex:1; padding:15px; border-radius:12px; background:#0f172a; border:1px solid rgba(255,255,255,0.1); color:white;">
                                <button class="btn btn-primary" onclick="submitWorkEntry()">Next &rarr;</button>
                            </div>
                        `;
                        
                        // Focus
                        setTimeout(() => document.getElementById('work-input-label').focus(), 100);
                    }
                }
            } catch(e) { console.error(e); container.innerHTML = '<div style="color:red">Error loading work</div>'; }
        }

        async function submitWorkEntry() {
            const label = document.getElementById('work-input-label').value;
            if(!label) return showToast("Please enter a value");
            
            try {
                const res = await fetchSecure('/work/submit', {
                    method: 'POST',
                    body: JSON.stringify({
                        employee_id: userId,
                        image_id: currentImageWorkId,
                        form_data: { label: label }
                    })
                });
                
                if(res.ok) {
                    // Load Next
                    loadWorkInterface(currentProjectWorkId);
                }
            } catch(e) { console.error(e); }
        }


            
        // --- CHAT LOGIC ---
        let chatSocket = null;
        let isChatOpen = false;

        function toggleChat() {
            const widget = document.getElementById('chatWidget');
            const fab = document.getElementById('chatFab');
            const badge = document.getElementById('msgBadge');
            
            isChatOpen = !isChatOpen;
            
            if(isChatOpen) {
                widget.style.display = 'flex';
                fab.style.display = 'none';
                badge.style.display = 'none';
                badge.innerText = '0';
                loadChatHistory();
                scrollToBottom();
            } else {
                widget.style.display = 'none';
                fab.style.display = 'flex';
            }
        }

        async function loadChatHistory() {
            const chatBody = document.getElementById('chatBody');
            chatBody.innerHTML = '<div style="text-align:center; color:rgba(255,255,255,0.3); padding:20px;">Loading history...</div>';
            
            try {
                const res = await fetchSecure('/api/support/my-history');
                if(!res || !res.ok) return;
                
                const messages = await res.json();
                chatBody.innerHTML = '';
                
                if(messages.length === 0) {
                     chatBody.innerHTML = '<div style="text-align:center; color:rgba(255,255,255,0.3); padding:20px; font-size:0.9rem;">üëã Hi there! Need help? <br>Send us a message below.</div>';
                     return;
                }
                
                messages.forEach(m => {
                    appendMessage(m.sender === 'Me', m.content, m.timestamp);
                });
                scrollToBottom();
                
            } catch(e) { console.error("Chat History Error", e); }
        }

        function connectChatWS() {
            if(!userId) return;
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            chatSocket = new WebSocket(`${protocol}://${window.location.host}/ws/support/${userId}`);
            
            chatSocket.onopen = () => {
                console.log("Chat Connected");
                // Optional: load history on connect? Better on open.
                const statusDot = document.querySelector('.status-dot');
                if(statusDot) statusDot.style.background = '#22c55e';
            };
            
            chatSocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                // Sender is Admin if likely coming from websocket
                // Format: { sender: 'Admin', message: '...' }
                
                appendMessage(data.sender === 'Me', data.content || data.message);
                
                if(!isChatOpen) {
                    const badge = document.getElementById('msgBadge');
                    badge.style.display = 'flex';
                    badge.innerText = parseInt(badge.innerText || '0') + 1;
                    badge.classList.add('highlight-chat');
                    playNotificationSound();
                } else {
                    scrollToBottom();
                }
            };
            
            chatSocket.onclose = () => {
                const statusDot = document.querySelector('.status-dot');
                if(statusDot) statusDot.style.background = '#ef4444'; // Red
                setTimeout(connectChatWS, 5000);
            };
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text) return;
            
            if(chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(text);
                appendMessage(true, text);
                input.value = '';
                scrollToBottom();
            } else {
                showToast("Chat disconnected. Reconnecting...");
            }
        }

        function appendMessage(isMe, text, timestamp) {
            const chatBody = document.getElementById('chatBody');
            const div = document.createElement('div');
            div.className = `chat-msg ${isMe ? 'msg-sent' : 'msg-received'} anim-fade-in`;
            div.innerHTML = `
                ${text}
                ${timestamp ? `<div style="font-size:0.65rem; opacity:0.6; text-align:right; margin-top:2px;">${new Date(timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>` : ''}
            `;
            chatBody.appendChild(div);
        }

        function scrollToBottom() {
            const chatBody = document.getElementById('chatBody');
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function playNotificationSound() {
            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 
            audio.volume = 0.5;
            audio.play().catch(e=>{});
        }
        
        // Initialize Chat when user data is loaded
        // We'll hook into verifyToken or loadData
        // For now, let's create a periodic check or just call it after loadData in main script
        
        // Let's hook into the global DOMContentLoaded but wait for userId
        const existOnLoad = window.onload;
        window.onload = function() {
            if(existOnLoad) existOnLoad();
            // Wait for userId to be populated
            const interval = setInterval(() => {
                if(window.userId) {
                    clearInterval(interval);
                    connectChatWS();
                    // Pre-load history count?
                }
            }, 500);
        };
    </script>

    <!-- CHAT WIDGET HTML -->
    <button class="chat-fab" id="chatFab" onclick="toggleChat()">
        <span class="chat-badge" id="msgBadge">0</span>
        <span style="font-size:1.2rem;">üí¨</span>
        <span>Helpdesk</span>
    </button>

    <div id="chatWidget">
        <div class="chat-header">
            <div style="display:flex; align-items:center;">
                <span class="status-dot"></span> Admin Support
            </div>
            <button onclick="toggleChat()" style="background:none; border:none; color:#0f172a; font-size:1.2rem; cursor:pointer; padding:0 5px;">&times;</button>
        </div>
        <div class="chat-body" id="chatBody">
            <div style="text-align:center; color:rgba(255,255,255,0.5); padding:20px; font-size:0.9rem;">
                üëã Hi there! Need help? <br>Send us a message.
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-input" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendChatMessage()">
            <button class="chat-send-btn" onclick="sendChatMessage()">‚û§</button>
        </div>
    </div>
</body>
</html>
